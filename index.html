<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Absen Siswa Digital</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: "Poppins", sans-serif;
      background: #f4f9ff;
    }

    /* ===== SPLASH SCREEN ===== */
    #splash {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, #1abc9c, #16a085);
      background-size: 300% 300%;
      animation: gradientMove 6s ease infinite;
      color: white;
      text-align: center;
      z-index: 9999;
      transition: opacity 0.8s ease, visibility 0.8s ease;
    }
    #splash.fade-out {
      opacity: 0;
      visibility: hidden;
    }

    @keyframes gradientMove {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    #splash img {
      width: 140px;
      height: 140px;
      margin-bottom: 25px;
      opacity: 0;
      transform: scale(0.7);
      animation: fadeInScale 1.5s ease forwards;
      filter: drop-shadow(0px 4px 8px rgba(0,0,0,0.3));
      /* üîπ Efek bulat dihapus */
      /* border-radius: 50%; */
      /* background: rgba(255,255,255,0.15); */
      /* padding: 10px; */
    }
    @keyframes fadeInScale {
      from { opacity: 0; transform: scale(0.7); }
      to { opacity: 1; transform: scale(1); }
    }

    .app-title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 10px;
      opacity: 0;
      animation: fadeIn 1.5s ease forwards 0.5s;
      text-shadow: 0 0 8px rgba(255,255,255,0.6);
    }
    .subtitle {
      font-size: 17px;
      font-weight: 400;
      margin-bottom: 35px;
      opacity: 0;
      animation: fadeIn 1.5s ease forwards 1s;
      color: #e3f7ff;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .loading-bar {
      width: 150px;
      height: 8px;
      background: rgba(255,255,255,0.25);
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      box-shadow: 0px 2px 6px rgba(0,0,0,0.2) inset;
    }
    .loading-bar::after {
      content: "";
      position: absolute;
      top: 0; left: -40%;
      width: 40%;
      height: 100%;
      background: linear-gradient(to right, #fff, #ccfff5);
      border-radius: 10px;
      animation: loading 2s infinite;
    }
    @keyframes loading {
      0% { left: -40%; }
      50% { left: 100%; }
      100% { left: -40%; }
    }

    /* ===== KONTEN UTAMA ===== */
    #main-app {
      display: none;
      padding: 20px;
      text-align: center;
      animation: fadeIn 1s ease forwards;
    }
    #main-app h1 {
      color: #16a085;
    }
  </style>
</head>
<body>
  <!-- Splash Screen -->
  <div id="splash">
    <img src="img/logo.png" alt="Logo Sekolah">
    <div class="app-title">ABSEN SISWA DIGITAL</div>
    <div class="subtitle">Aplikasi untuk Guru dan Siswa</div>
    <div class="loading-bar"></div>
  </div>

  <!-- Konten Utama -->
    <!-- Suara Intro -->
  <audio id="splash-sound" src="sound/intro.mp3" preload="auto"></audio>

  <script>
    window.addEventListener("load", function() {
      const audio = document.getElementById("splash-sound");
      audio.play().catch(() => {
        console.warn("Autoplay dicegah browser, klik layar untuk memulai suara.");
        document.body.addEventListener("click", () => audio.play(), { once: true });
      });

      // Splash hilang setelah 5 detik
      setTimeout(() => {
        document.getElementById("splash").classList.add("fade-out");
        setTimeout(() => {
          document.getElementById("splash").style.display = "none";
          document.getElementById("main-app").style.display = "block";
          audio.pause();
          audio.currentTime = 0;
        }, 800);
      }, 5000);
    });
  </script>
</body>
</html>

<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABSEN SISWA DIGITAL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@latest/dist/jspdf.plugin.autotable.min.js"></script>
    <style>
        .tab-active {
            background: linear-gradient(135deg, #14b8a6, #0d9488);
            color: white;
        }
        .tab-inactive {
            background: #f0fdfa;
            color: #0f766e;
        }
        .btn-hadir { background-color: #22c55e; }
        .btn-sakit { background-color: #3b82f6; }
        .btn-izin { background-color: #eab308; }
        .btn-alpa { background-color: #ef4444; }
        .holiday-display {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            color: white;
        }
        .sunday-holiday {
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
        }
        .status-indicator {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-teal-400 to-teal-500 min-h-screen">
    <div class="max-w-md mx-auto bg-teal-50 min-h-screen shadow-xl relative">
        <!-- Header -->
        <div class="bg-gradient-to-r from-teal-400 to-teal-500 text-white p-4 text-center relative">
            <h1 class="text-xl font-bold">ABSEN SISWA</h1>
            <p class="text-xs font-medium opacity-90">DIGITAL</p>
            <div id="autosaveStatus" class="absolute bottom-1 right-1 bg-gray-800 text-white px-2 py-1 rounded text-xs status-indicator">AUTO</div>
        </div>



        <!-- Date Time Info -->
        <div class="p-3 bg-teal-100 border-b text-sm">
            <div class="flex justify-between items-center">
                <div>
                    <span class="font-semibold text-teal-700">HARI:</span>
                    <span id="currentDay"></span>
                </div>
                <div>
                    <span class="font-semibold text-teal-700">TANGGAL:</span>
                    <span id="currentDate"></span>
                </div>
                <div>
                    <span class="font-semibold text-teal-700">JAM:</span>
                    <span id="currentTime"></span>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex bg-gray-100 overflow-x-auto">
            <button onclick="showTab('home')" id="tab-home" class="tab-active px-3 py-2 text-xs font-semibold whitespace-nowrap" style="background: linear-gradient(135deg, #20b2aa, #48d1cc) !important; color: white !important;">
                ‚òÜ
            </button>
            <button onclick="showTab('dataSiswa')" id="tab-dataSiswa" class="tab-inactive px-3 py-2 text-xs font-semibold whitespace-nowrap">SISWA</button>
            <button onclick="showTab('absen')" id="tab-absen" class="tab-inactive px-3 py-2 text-xs font-semibold whitespace-nowrap">ABSEN</button>
            <button onclick="showTab('riwayat')" id="tab-riwayat" class="tab-inactive px-3 py-2 text-xs font-semibold whitespace-nowrap">RIWAYAT</button>
            <button onclick="showTab('statistik')" id="tab-statistik" class="tab-inactive px-3 py-2 text-xs font-semibold whitespace-nowrap">REKAP</button>
            <button onclick="showTab('download')" id="tab-download" class="tab-inactive px-3 py-2 text-xs font-semibold whitespace-nowrap">UNDUH</button>
        </div>

        <!-- Tab Content -->
        <div class="p-4">
            <!-- Home Tab -->
            <div id="content-home" class="tab-content">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-teal-700 mb-2">BERANDA</h2>
                </div>

                <!-- School Information Display -->
                <div class="mb-4 bg-gradient-to-r from-teal-50 to-blue-50 rounded-lg p-3 border-l-4 border-teal-500">
                    <div class="flex justify-end items-center mb-2">
                        <button onclick="showSchoolInfoPopup()" class="bg-teal-500 text-white px-2 py-1 rounded text-xs hover:bg-teal-600">‚úèÔ∏è</button>
                    </div>
                    <div class="grid grid-cols-1 gap-3 text-sm">
                        <div class="bg-teal-50 rounded-lg p-3 border border-teal-200">
                            <div class="text-teal-600 text-xs mb-1">üè´ NAMA SEKOLAH</div>
                            <div id="displayNamaSekolah" class="font-semibold text-teal-800">Belum diisi</div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-teal-50 rounded-lg p-3 border border-teal-200">
                                <div class="text-teal-600 text-xs mb-1">üéì KELAS</div>
                                <div id="displayKelas" class="font-semibold text-teal-800">Belum diisi</div>
                            </div>
                            <div class="bg-teal-50 rounded-lg p-3 border border-teal-200">
                                <div class="text-teal-600 text-xs mb-1">üë®‚Äçüè´ WALI KELAS</div>
                                <div id="displayWaliKelas" class="font-semibold text-teal-800">Belum diisi</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-gradient-to-r from-blue-400 to-blue-500 text-white p-4 rounded-lg text-center">
                        <div class="text-xl font-bold" id="maleStudents">0/0 SISWA</div>
                        <div class="text-sm">üë® SISWA LAKI-LAKI</div>
                    </div>
                    <div class="bg-gradient-to-r from-pink-400 to-pink-500 text-white p-4 rounded-lg text-center">
                        <div class="text-xl font-bold" id="femaleStudents">0/0 SISWA</div>
                        <div class="text-sm">üë© SISWA PEREMPUAN</div>
                    </div>
                </div>

                <!-- Statistik Kehadiran Seluruh Siswa -->
                <div class="mb-4">
                    <h3 class="text-sm font-bold text-teal-700 mb-2">üìä STATISTIK KEHADIRAN SELURUH SISWA</h3>
                    <div class="bg-gradient-to-r from-blue-50 to-teal-50 rounded-lg p-4 border-l-4 border-blue-400">
                        <!-- Attendance Pie Chart -->
                        <div class="flex items-center justify-between">
                            <!-- Pie Chart -->
                            <div class="relative">
                                <svg id="pieChart" width="120" height="120" class="transform -rotate-90">
                                    <!-- Background circle -->
                                    <circle cx="60" cy="60" r="50" fill="none" stroke="#f3f4f6" stroke-width="8"/>
                                    
                                    <!-- Pie segments -->
                                    <circle id="segmentHadir" cx="60" cy="60" r="50" fill="none" stroke="#22c55e" stroke-width="8" 
                                        stroke-dasharray="0 314" stroke-dashoffset="0" opacity="0" 
                                        style="transition: all 1.5s ease-out;">
                                    </circle>
                                    <circle id="segmentSakit" cx="60" cy="60" r="50" fill="none" stroke="#3b82f6" stroke-width="8" 
                                        stroke-dasharray="0 314" stroke-dashoffset="0" opacity="0" 
                                        style="transition: all 1.5s ease-out;">
                                    </circle>
                                    <circle id="segmentIzin" cx="60" cy="60" r="50" fill="none" stroke="#eab308" stroke-width="8" 
                                        stroke-dasharray="0 314" stroke-dashoffset="0" opacity="0" 
                                        style="transition: all 1.5s ease-out;">
                                    </circle>
                                    <circle id="segmentAlpa" cx="60" cy="60" r="50" fill="none" stroke="#ef4444" stroke-width="8" 
                                        stroke-dasharray="0 314" stroke-dashoffset="0" opacity="0" 
                                        style="transition: all 1.5s ease-out;">
                                    </circle>
                                    
                                    <!-- Center text -->
                                    <text x="60" y="65" text-anchor="middle" class="fill-gray-700 text-xs font-bold transform rotate-90" 
                                        style="transform-origin: 60px 60px;">
                                        <tspan id="totalCount">0</tspan>
                                    </text>
                                </svg>
                            </div>
                            
                            <!-- Legend -->
                            <div class="flex-1 ml-4 space-y-2">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                                        <span class="text-xs font-medium">HADIR</span>
                                    </div>
                                    <span id="hadirPercentage" class="text-xs font-bold text-green-600">0%</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>
                                        <span class="text-xs font-medium">SAKIT</span>
                                    </div>
                                    <span id="sakitPercentage" class="text-xs font-bold text-blue-600">0%</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <span class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></span>
                                        <span class="text-xs font-medium">IZIN</span>
                                    </div>
                                    <span id="izinPercentage" class="text-xs font-bold text-yellow-600">0%</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                                        <span class="text-xs font-medium">ALPA</span>
                                    </div>
                                    <span id="alpaPercentage" class="text-xs font-bold text-red-600">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="flex justify-center mb-4">
                    <button onclick="showTab('statistik')" class="bg-gradient-to-r from-blue-400 to-blue-500 text-white px-6 py-3 rounded-lg text-center hover:from-blue-500 hover:to-blue-600 transition-all">
                        <div class="text-sm font-semibold">LIHAT REKAP</div>
                    </button>
                </div>

                <!-- 5 Siswa Terajin -->
                <div class="mb-4">
                    <h3 class="text-sm font-bold text-teal-700 mb-2">üèÜ 5 SISWA TERAJIN</h3>
                    <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg p-3 border-l-4 border-yellow-400">
                        <div id="topStudents" class="space-y-1">
                            <p class="text-center text-gray-500 text-xs">Belum ada data kehadiran</p>
                        </div>
                    </div>
                </div>




            </div>

            <!-- Data Siswa Tab -->
            <div id="content-dataSiswa" class="tab-content hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-teal-700">üë®‚Äçüéì DATA SISWA</h2>
                    <div class="flex space-x-2">
                        <button onclick="showUploadPopup()" class="bg-blue-500 text-white px-3 py-2 rounded text-xs">üìÅ UPLOAD</button>
                        <button onclick="showAddStudentPopup()" class="bg-teal-500 text-white px-3 py-2 rounded text-xs">‚ûï TAMBAH</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full border border-teal-300 text-sm bg-teal-50">
                        <thead class="bg-teal-200">
                            <tr>
                                <th class="border border-teal-300 p-2 text-xs text-teal-800">NO</th>
                                <th class="border border-teal-300 p-2 text-xs text-teal-800">NAMA SISWA</th>
                                <th class="border border-teal-300 p-2 text-xs text-teal-800">NIS</th>
                                <th class="border border-teal-300 p-2 text-xs text-teal-800">L/P</th>
                                <th class="border border-teal-300 p-2 text-xs text-teal-800">AKSI</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Absen Tab -->
            <div id="content-absen" class="tab-content hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-teal-700">‚úÖ ABSEN SISWA</h2>
                    <button onclick="showCalendarPopup()" class="bg-teal-500 text-white px-3 py-2 rounded text-xs">üìÖ PILIH TANGGAL</button>
                </div>
                
                <div class="mb-4 p-3 bg-teal-50 rounded">
                    <div class="text-center">
                        <span class="font-semibold text-teal-700">TANGGAL: </span>
                        <span id="selectedDate" class="font-bold"></span>
                    </div>
                </div>

                <!-- Holiday Content -->
                <div id="holidayContent" class="hidden">
                    <div id="holidayDisplay" class="holiday-display">
                        <h3 class="text-2xl font-bold mb-4">üèñÔ∏è HARI LIBUR üèñÔ∏è</h3>
                        <p class="text-lg">Tidak ada kegiatan belajar mengajar</p>
                    </div>
                    <div class="text-center mt-4">
                        <button onclick="toggleHoliday()" id="holidayBtn" class="bg-red-500 text-white px-4 py-2 rounded">‚ùå BATAL LIBUR</button>
                    </div>
                </div>

                <!-- Attendance Content -->
                <div id="attendanceContent">
                    <div class="flex justify-between items-center mb-4">
                        <button onclick="markAllPresent()" class="bg-green-500 text-white px-3 py-2 rounded text-xs">‚úÖ HADIR SEMUA</button>
                        <div class="flex space-x-2">
                            <button onclick="toggleHoliday()" id="holidayBtn" class="bg-yellow-500 text-white px-3 py-2 rounded text-xs">üèñÔ∏è LIBUR</button>
                            <button onclick="editAttendance()" id="editBtn" class="bg-orange-500 text-white px-3 py-2 rounded text-xs hidden">‚úèÔ∏è EDIT</button>
                            <button onclick="saveAttendance()" id="saveBtn" class="bg-blue-500 text-white px-3 py-2 rounded text-xs">üíæ SIMPAN</button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full border border-teal-300 text-sm bg-teal-50">
                            <thead class="bg-teal-200">
                                <tr>
                                    <th class="border border-teal-300 p-2 text-xs text-teal-800">NO</th>
                                    <th class="border border-teal-300 p-2 text-xs text-teal-800">NAMA SISWA</th>
                                    <th class="border border-teal-300 p-2 text-xs text-teal-800">STATUS KEHADIRAN</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceTableBody">
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4 p-3 bg-teal-50 rounded">
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div>H = HADIR</div>
                            <div>S = SAKIT</div>
                            <div>I = IZIN</div>
                            <div>A = ALPA</div>
                        </div>
                    </div>
                </div>
            </div>



            <!-- Riwayat Tab -->
            <div id="content-riwayat" class="tab-content hidden">
                <h2 class="text-lg font-bold text-teal-700 mb-4">üìä RIWAYAT ABSEN</h2>
                
                <div class="flex space-x-2 mb-4">
                    <select id="monthSelect" class="border rounded p-2 text-sm" onchange="loadHistory()">
                        <option value="0">Januari</option>
                        <option value="1">Februari</option>
                        <option value="2">Maret</option>
                        <option value="3">April</option>
                        <option value="4">Mei</option>
                        <option value="5">Juni</option>
                        <option value="6">Juli</option>
                        <option value="7">Agustus</option>
                        <option value="8">September</option>
                        <option value="9">Oktober</option>
                        <option value="10">November</option>
                        <option value="11">Desember</option>
                    </select>
                    <select id="yearSelect" class="border rounded p-2 text-sm" onchange="loadHistory()">
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                    </select>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full border border-teal-300 text-xs bg-teal-50">
                        <thead class="bg-teal-200">
                            <tr id="historyHeader">
                                <th class="border border-teal-300 p-1 sticky left-0 bg-teal-200 z-10 text-teal-800">NO</th>
                                <th class="border border-teal-300 p-1 sticky left-8 bg-teal-200 z-10 text-teal-800">NAMA</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody">
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-4 p-3 bg-teal-50 rounded">
                    <div class="grid grid-cols-3 gap-2 text-xs">
                        <div>H = HADIR</div>
                        <div>S = SAKIT</div>
                        <div>I = IZIN</div>
                        <div>A = ALPA</div>
                        <div>M = MINGGU</div>
                        <div>L = LIBUR</div>
                    </div>
                </div>
            </div>

            <!-- Statistik Tab -->
            <div id="content-statistik" class="tab-content hidden">
                <h2 class="text-lg font-bold text-teal-700 mb-4">üìà REKAP KEHADIRAN</h2>
                
                <div class="flex space-x-2 mb-4">
                    <select id="statMonth" class="border rounded p-2 text-sm" onchange="loadStatistics()">
                        <option value="all">Semua Bulan</option>
                        <option value="0">Januari</option>
                        <option value="1">Februari</option>
                        <option value="2">Maret</option>
                        <option value="3">April</option>
                        <option value="4">Mei</option>
                        <option value="5">Juni</option>
                        <option value="6">Juli</option>
                        <option value="7">Agustus</option>
                        <option value="8">September</option>
                        <option value="9">Oktober</option>
                        <option value="10">November</option>
                        <option value="11">Desember</option>
                    </select>
                    <select id="statYear" class="border rounded p-2 text-sm" onchange="loadStatistics()">
                        <option value="all">Semua Tahun</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                    </select>
                </div>

                <div id="statistikContent">
                    <p class="text-center text-gray-500">Belum ada data siswa</p>
                </div>
            </div>

            <!-- Download Tab -->
            <div id="content-download" class="tab-content hidden">
                <h2 class="text-lg font-bold text-teal-700 mb-4">üì• UNDUH & KIRIM</h2>
                
                <div class="space-y-4">
                    <!-- Download Riwayat -->
                    <div class="bg-blue-50 p-4 rounded border-l-4 border-blue-500">
                        <h3 class="font-bold text-blue-700 mb-2">üìä DOWNLOAD RIWAYAT</h3>
                        <div class="grid grid-cols-2 gap-2 mb-3">
                            <select id="downloadMonth" class="border rounded p-2 text-sm">
                                <option value="all">Semua Bulan</option>
                                <option value="0">Januari</option>
                                <option value="1">Februari</option>
                                <option value="2">Maret</option>
                                <option value="3">April</option>
                                <option value="4">Mei</option>
                                <option value="5">Juni</option>
                                <option value="6">Juli</option>
                                <option value="7">Agustus</option>
                                <option value="8">September</option>
                                <option value="9">Oktober</option>
                                <option value="10">November</option>
                                <option value="11">Desember</option>
                            </select>
                            <select id="downloadYear" class="border rounded p-2 text-sm">
                                <option value="all">Semua Tahun</option>
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-1 gap-2">
                            <div class="relative">
                                <button onclick="toggleExcelOptions('history')" class="w-full bg-green-500 text-white p-2 rounded text-sm flex items-center justify-between">
                                    üìä EXCEL <span id="historyArrow">‚ñº</span>
                                </button>
                                <div id="historyExcelOptions" class="hidden absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-b shadow-lg z-10">
                                    <button onclick="downloadHistory('xlsx')" class="w-full text-left p-2 hover:bg-gray-100 text-sm border-b">üìä Excel 2007+ (.xlsx)</button>
                                    <button onclick="downloadHistory('xls')" class="w-full text-left p-2 hover:bg-gray-100 text-sm border-b">üìä Excel 97-2003 (.xls)</button>
                                    <button onclick="downloadHistory('csv')" class="w-full text-left p-2 hover:bg-gray-100 text-sm border-b">üìÑ CSV (.csv)</button>
                                    <button onclick="downloadHistory('ods')" class="w-full text-left p-2 hover:bg-gray-100 text-sm">üìä OpenDocument (.ods)</button>
                                </div>
                            </div>
                            <button onclick="downloadHistory('pdf')" class="bg-red-500 text-white p-2 rounded text-sm">üìÑ PDF</button>
                        </div>
                    </div>

                    <!-- Download Rekap -->
                    <div class="bg-teal-50 p-4 rounded border-l-4 border-teal-500">
                        <h3 class="font-bold text-teal-700 mb-2">üìà DOWNLOAD REKAP</h3>
                        <div class="grid grid-cols-2 gap-2 mb-3">
                            <select id="rekapMonth" class="border rounded p-2 text-sm">
                                <option value="all">Semua Bulan</option>
                                <option value="0">Januari</option>
                                <option value="1">Februari</option>
                                <option value="2">Maret</option>
                                <option value="3">April</option>
                                <option value="4">Mei</option>
                                <option value="5">Juni</option>
                                <option value="6">Juli</option>
                                <option value="7">Agustus</option>
                                <option value="8">September</option>
                                <option value="9">Oktober</option>
                                <option value="10">November</option>
                                <option value="11">Desember</option>
                            </select>
                            <select id="rekapYear" class="border rounded p-2 text-sm">
                                <option value="all">Semua Tahun</option>
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-1 gap-2">
                            <div class="relative">
                                <button onclick="toggleExcelOptions('rekap')" class="w-full bg-green-500 text-white p-2 rounded text-sm flex items-center justify-between">
                                    üìä EXCEL <span id="rekapArrow">‚ñº</span>
                                </button>
                                <div id="rekapExcelOptions" class="hidden absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-b shadow-lg z-10">
                                    <button onclick="downloadRekap('xlsx')" class="w-full text-left p-2 hover:bg-gray-100 text-sm border-b">üìä Excel 2007+ (.xlsx)</button>
                                    <button onclick="downloadRekap('xls')" class="w-full text-left p-2 hover:bg-gray-100 text-sm border-b">üìä Excel 97-2003 (.xls)</button>
                                    <button onclick="downloadRekap('csv')" class="w-full text-left p-2 hover:bg-gray-100 text-sm border-b">üìÑ CSV (.csv)</button>
                                    <button onclick="downloadRekap('ods')" class="w-full text-left p-2 hover:bg-gray-100 text-sm">üìä OpenDocument (.ods)</button>
                                </div>
                            </div>
                            <button onclick="downloadRekap('pdf')" class="bg-red-500 text-white p-2 rounded text-sm">üìÑ PDF</button>
                        </div>
                    </div>

                    <!-- Kirim Laporan -->
                    <div class="bg-purple-50 p-4 rounded border-l-4 border-purple-500">
                        <h3 class="font-bold text-purple-700 mb-2">üì§ KIRIM LAPORAN</h3>
                        <div class="grid grid-cols-2 gap-2 mb-3">
                            <select id="sendMonth" class="border rounded p-2 text-sm">
                                <option value="all">Semua Bulan</option>
                                <option value="0">Januari</option>
                                <option value="1">Februari</option>
                                <option value="2">Maret</option>
                                <option value="3">April</option>
                                <option value="4">Mei</option>
                                <option value="5">Juni</option>
                                <option value="6">Juli</option>
                                <option value="7">Agustus</option>
                                <option value="8">September</option>
                                <option value="9">Oktober</option>
                                <option value="10">November</option>
                                <option value="11">Desember</option>
                            </select>
                            <select id="sendYear" class="border rounded p-2 text-sm">
                                <option value="all">Semua Tahun</option>
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="sendWhatsApp()" class="bg-green-500 text-white p-2 rounded text-sm">üì± WHATSAPP</button>
                            <button onclick="sendEmail()" class="bg-blue-500 text-white p-2 rounded text-sm">üìß EMAIL</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Student Popup -->
    <div id="addStudentPopup" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-teal-50 rounded-lg p-6 w-full max-w-sm border-2 border-teal-200">
                <h3 class="text-lg font-bold text-teal-800 mb-4">‚ûï TAMBAH SISWA</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-1">NAMA SISWA:</label>
                        <input type="text" id="studentName" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">NIS:</label>
                        <input type="text" id="studentNIS" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">JENIS KELAMIN:</label>
                        <div class="flex space-x-2">
                            <button onclick="selectGender('L')" id="genderL" class="flex-1 p-2 border rounded bg-gray-100">LAKI-LAKI</button>
                            <button onclick="selectGender('P')" id="genderP" class="flex-1 p-2 border rounded bg-gray-100">PEREMPUAN</button>
                        </div>
                    </div>
                </div>
                <div class="flex space-x-2 mt-6">
                    <button onclick="closeAddStudentPopup()" class="flex-1 bg-gray-500 text-white p-2 rounded">BATAL</button>
                    <button onclick="saveStudent()" class="flex-1 bg-teal-500 text-white p-2 rounded">SIMPAN</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Student Popup -->
    <div id="editStudentPopup" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-teal-50 rounded-lg p-6 w-full max-w-sm border-2 border-teal-200">
                <h3 class="text-lg font-bold text-teal-800 mb-4">‚úèÔ∏è EDIT SISWA</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-1">NAMA SISWA:</label>
                        <input type="text" id="editStudentName" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">NIS:</label>
                        <input type="text" id="editStudentNIS" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">JENIS KELAMIN:</label>
                        <div class="flex space-x-2">
                            <button onclick="selectEditGender('L')" id="editGenderL" class="flex-1 p-2 border rounded bg-gray-100">LAKI-LAKI</button>
                            <button onclick="selectEditGender('P')" id="editGenderP" class="flex-1 p-2 border rounded bg-gray-100">PEREMPUAN</button>
                        </div>
                    </div>
                </div>
                <div class="flex space-x-2 mt-6">
                    <button onclick="closeEditStudentPopup()" class="flex-1 bg-gray-500 text-white p-2 rounded">BATAL</button>
                    <button onclick="updateStudent()" class="flex-1 bg-teal-500 text-white p-2 rounded">SIMPAN</button>
                    <button onclick="deleteStudent()" class="flex-1 bg-red-500 text-white p-2 rounded">HAPUS</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar Popup -->
    <div id="calendarPopup" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-teal-50 rounded-lg p-6 w-full max-w-sm border-2 border-teal-200">
                <h3 class="text-lg font-bold text-teal-800 mb-4 text-center">üìÖ PILIH TANGGAL</h3>
                <div class="flex justify-between items-center mb-4">
                    <button onclick="changeMonth(-1)" class="bg-teal-500 text-white px-3 py-1 rounded">‚Äπ</button>
                    <span id="calendarMonthYear" class="font-semibold"></span>
                    <button onclick="changeMonth(1)" class="bg-teal-500 text-white px-3 py-1 rounded">‚Ä∫</button>
                </div>
                <div class="grid grid-cols-7 gap-1 mb-4">
                    <div class="text-center text-xs font-semibold p-2">MIN</div>
                    <div class="text-center text-xs font-semibold p-2">SEN</div>
                    <div class="text-center text-xs font-semibold p-2">SEL</div>
                    <div class="text-center text-xs font-semibold p-2">RAB</div>
                    <div class="text-center text-xs font-semibold p-2">KAM</div>
                    <div class="text-center text-xs font-semibold p-2">JUM</div>
                    <div class="text-center text-xs font-semibold p-2">SAB</div>
                </div>
                <div id="calendarDays" class="grid grid-cols-7 gap-1 mb-4">
                </div>
                <button onclick="closeCalendarPopup()" class="w-full bg-gray-500 text-white p-2 rounded">TUTUP</button>
            </div>
        </div>
    </div>



    <!-- School Info Edit Popup -->
    <div id="schoolInfoPopup" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-teal-50 rounded-lg p-6 w-full max-w-md border-2 border-teal-200">
                <h3 class="text-lg font-bold text-teal-800 mb-4">üè´ EDIT INFORMASI SEKOLAH</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-1">üè´ NAMA SEKOLAH:</label>
                        <input type="text" id="editNamaSekolah" class="w-full p-2 border rounded focus:border-teal-500 focus:outline-none" placeholder="Masukkan nama sekolah">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">üéì KELAS:</label>
                        <input type="text" id="editKelas" class="w-full p-2 border rounded focus:border-teal-500 focus:outline-none" placeholder="Masukkan kelas">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">üë®‚Äçüè´ WALI KELAS:</label>
                        <input type="text" id="editWaliKelas" class="w-full p-2 border rounded focus:border-teal-500 focus:outline-none" placeholder="Masukkan nama wali kelas">
                    </div>
                </div>
                <div class="flex space-x-2 mt-6">
                    <button onclick="closeSchoolInfoPopup()" class="flex-1 bg-gray-500 text-white p-2 rounded">BATAL</button>
                    <button onclick="saveSchoolInfo()" class="flex-1 bg-teal-500 text-white p-2 rounded">SIMPAN</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Popup -->
    <div id="uploadPopup" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-teal-50 rounded-lg p-6 w-full max-w-md border-2 border-teal-200">
                <h3 class="text-lg font-bold text-teal-800 mb-4">üìÅ UPLOAD DATA SISWA</h3>
                
                <div class="mb-4 p-3 bg-blue-50 rounded">
                    <h4 class="font-semibold text-blue-700 mb-2">FORMAT FILE:</h4>
                    <ul class="text-sm text-blue-600 space-y-1">
                        <li>‚Ä¢ Excel (.xlsx, .xls)</li>
                        <li>‚Ä¢ CSV (.csv)</li>
                        <li>‚Ä¢ Text (.txt)</li>
                    </ul>
                </div>
                
                <div class="mb-4 p-3 bg-yellow-50 rounded border-l-4 border-yellow-400">
                    <h4 class="font-semibold text-yellow-700 mb-2">FORMAT DATA:</h4>
                    <p class="text-sm text-yellow-600 mb-2">Kolom harus berurutan:</p>
                    <p class="text-xs font-mono bg-yellow-100 p-2 rounded">NAMA | NIS | JENIS_KELAMIN</p>
                    <p class="text-xs text-yellow-600 mt-2">Jenis Kelamin: L atau P</p>
                </div>
                
                <div class="mb-4">
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv,.txt" class="w-full p-2 border rounded">
                </div>
                
                <div class="mb-4">
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="replaceData">
                        <span class="text-sm text-red-600">Ganti semua data (hapus data lama)</span>
                    </label>
                </div>
                
                <div class="flex space-x-2">
                    <button onclick="closeUploadPopup()" class="flex-1 bg-gray-500 text-white p-2 rounded">BATAL</button>
                    <button onclick="processUpload()" class="flex-1 bg-blue-500 text-white p-2 rounded">UPLOAD</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let students = [];
        let attendance = {};
        let holidays = new Set();
        let currentEditingStudent = null;
        let selectedGender = '';
        let selectedEditGender = '';
        let currentCalendarDate = new Date();
        let selectedAttendanceDate = new Date();
        let attendanceSaved = false;

        // Sound notification functions
        function playSound(type) {
            try {
                // Create audio context for Web Audio API
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                let frequency, duration, volume;
                
                switch(type) {
                    case 'hadir':
                        frequency = 800; // High pleasant tone
                        duration = 0.2;
                        volume = 0.3;
                        break;
                    case 'sakit':
                        frequency = 600; // Medium tone
                        duration = 0.25;
                        volume = 0.3;
                        break;
                    case 'izin':
                        frequency = 500; // Lower tone
                        duration = 0.25;
                        volume = 0.3;
                        break;
                    case 'alpa':
                        frequency = 300; // Low warning tone
                        duration = 0.3;
                        volume = 0.4;
                        break;
                    case 'save':
                        // Success sound - two tones
                        playSuccessSound(audioContext);
                        return;
                    case 'error':
                        frequency = 200; // Very low error tone
                        duration = 0.5;
                        volume = 0.4;
                        break;
                    default:
                        frequency = 440;
                        duration = 0.2;
                        volume = 0.3;
                }
                
                // Create oscillator
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                oscillator.type = 'sine';
                
                // Set volume with fade out
                gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
                
            } catch (error) {
                // Fallback: use system beep or console log
                console.log(`üîä Sound: ${type}`);
            }
        }

        function playSuccessSound(audioContext) {
            try {
                // First tone
                const osc1 = audioContext.createOscillator();
                const gain1 = audioContext.createGain();
                osc1.connect(gain1);
                gain1.connect(audioContext.destination);
                
                osc1.frequency.setValueAtTime(600, audioContext.currentTime);
                osc1.type = 'sine';
                gain1.gain.setValueAtTime(0.3, audioContext.currentTime);
                gain1.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                
                osc1.start(audioContext.currentTime);
                osc1.stop(audioContext.currentTime + 0.15);
                
                // Second higher tone
                const osc2 = audioContext.createOscillator();
                const gain2 = audioContext.createGain();
                osc2.connect(gain2);
                gain2.connect(audioContext.destination);
                
                osc2.frequency.setValueAtTime(800, audioContext.currentTime + 0.1);
                osc2.type = 'sine';
                gain2.gain.setValueAtTime(0.3, audioContext.currentTime + 0.1);
                gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                osc2.start(audioContext.currentTime + 0.1);
                osc2.stop(audioContext.currentTime + 0.3);
                
            } catch (error) {
                console.log('üîä Success sound');
            }
        }



        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            updateDateTime();
            setInterval(updateDateTime, 1000);
            updateSelectedDate();
            loadStudentTable();
            loadAttendanceTable();
            updateHomeStats();
            updateRecentActivity();
            
            // Set current month/year for all selectors
            const now = new Date();
            document.getElementById('monthSelect').value = now.getMonth();
            document.getElementById('yearSelect').value = now.getFullYear();
            document.getElementById('statMonth').value = now.getMonth();
            document.getElementById('statYear').value = now.getFullYear();
            document.getElementById('downloadMonth').value = now.getMonth();
            document.getElementById('downloadYear').value = now.getFullYear();
            document.getElementById('rekapMonth').value = now.getMonth();
            document.getElementById('rekapYear').value = now.getFullYear();
            document.getElementById('sendMonth').value = now.getMonth();
            document.getElementById('sendYear').value = now.getFullYear();
            
            // Initialize school info display
            updateSchoolInfoDisplay();
        });

        // Data management
        function saveData() {
            try {
                // Get current school info from display or stored data
                const savedData = localStorage.getItem('absenSiswaData');
                let currentSchoolInfo = {};
                
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    currentSchoolInfo = parsedData.schoolInfo || {};
                }
                
                const data = {
                    students: students,
                    attendance: attendance,
                    holidays: Array.from(holidays),
                    schoolInfo: currentSchoolInfo,
                    lastSaved: new Date().toISOString()
                };
                localStorage.setItem('absenSiswaData', JSON.stringify(data));
                updateAutosaveStatus('TERSIMPAN');
            } catch (error) {
                console.error('Error saving data:', error);
                updateAutosaveStatus('ERROR');
            }
        }

        function loadData() {
            try {
                const savedData = localStorage.getItem('absenSiswaData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    students = data.students || [];
                    attendance = data.attendance || {};
                    holidays = new Set(data.holidays || []);
                    
                    if (data.schoolInfo) {
                        // Update display elements
                        updateSchoolInfoDisplay(data.schoolInfo);
                    }
                    
                    updateStudentCount();
                    updateAutosaveStatus('DIMUAT');
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function updateAutosaveStatus(status) {
            const statusEl = document.getElementById('autosaveStatus');
            statusEl.textContent = status;
            
            setTimeout(() => {
                statusEl.textContent = 'AUTO';
            }, 2000);
        }



        // Date and time functions
        function updateDateTime() {
            const now = new Date();
            const days = ['MINGGU', 'SENIN', 'SELASA', 'RABU', 'KAMIS', 'JUMAT', 'SABTU'];
            
            document.getElementById('currentDay').textContent = days[now.getDay()];
            document.getElementById('currentDate').textContent = now.toLocaleDateString('id-ID');
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('id-ID');
        }

        function updateSelectedDate() {
            const days = ['MINGGU', 'SENIN', 'SELASA', 'RABU', 'KAMIS', 'JUMAT', 'SABTU'];
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            
            const dayName = days[selectedAttendanceDate.getDay()];
            const day = selectedAttendanceDate.getDate();
            const month = months[selectedAttendanceDate.getMonth()];
            const year = selectedAttendanceDate.getFullYear();
            
            document.getElementById('selectedDate').textContent = `${dayName}, ${day} ${month} ${year}`;
            checkHolidayStatus();
        }

        // Home functions
        function updateHomeStats() {
            // Count male and female students
            const maleCount = students.filter(s => s.gender === 'L').length;
            const femaleCount = students.filter(s => s.gender === 'P').length;
            const totalStudents = students.length;
            
            document.getElementById('maleStudents').textContent = `${maleCount}/${totalStudents} SISWA`;
            document.getElementById('femaleStudents').textContent = `${femaleCount}/${totalStudents} SISWA`;
            

            
            // Update top students and overall statistics
            updateTopStudents();
            updateOverallStatistics();
        }



        function updateTopStudents() {
            if (students.length === 0) {
                document.getElementById('topStudents').innerHTML = '<p class="text-center text-gray-500">Belum ada data siswa</p>';
                return;
            }

            // Calculate attendance percentage for each student
            const studentStats = students.map(student => {
                let hadir = 0, total = 0;
                
                Object.keys(attendance).forEach(dateKey => {
                    const date = new Date(dateKey);
                    // Only count weekdays and non-holidays
                    if (date.getDay() !== 0 && !holidays.has(dateKey) && attendance[dateKey].students[student.id]) {
                        total++;
                        if (attendance[dateKey].students[student.id] === 'hadir') {
                            hadir++;
                        }
                    }
                });
                
                const percentage = total > 0 ? (hadir / total) * 100 : 0;
                return {
                    ...student,
                    hadir: hadir,
                    total: total,
                    percentage: percentage
                };
            });

            // Sort by percentage (descending) and take top 5
            const topStudents = studentStats
                .filter(student => student.total > 0)
                .sort((a, b) => b.percentage - a.percentage)
                .slice(0, 5);

            const topStudentsEl = document.getElementById('topStudents');
            
            if (topStudents.length === 0) {
                topStudentsEl.innerHTML = '<p class="text-center text-gray-500">Belum ada data kehadiran</p>';
                return;
            }

            let html = '';
            topStudents.forEach((student, index) => {
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üèÖ';
                const bgColor = index === 0 ? 'bg-yellow-100 border-yellow-300' : 
                               index === 1 ? 'bg-gray-100 border-gray-300' : 
                               index === 2 ? 'bg-orange-100 border-orange-300' : 'bg-blue-50 border-blue-200';
                
                html += `
                    <div class="flex items-center justify-between p-2 ${bgColor} border rounded-md">
                        <div class="flex items-center space-x-2">
                            <span class="text-sm">${medal}</span>
                            <div>
                                <div class="font-semibold text-xs">${student.name}</div>
                                <div class="text-xs text-gray-600">${student.hadir}/${student.total} hari</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-sm ${index === 0 ? 'text-yellow-600' : index === 1 ? 'text-gray-600' : index === 2 ? 'text-orange-600' : 'text-blue-600'}">${student.percentage.toFixed(1)}%</div>
                        </div>
                    </div>
                `;
            });
            
            topStudentsEl.innerHTML = html;
        }

        function updateOverallStatistics() {
            let totalHadir = 0, totalSakit = 0, totalIzin = 0, totalAlpa = 0;
            
            // Calculate overall statistics from all attendance data
            Object.keys(attendance).forEach(dateKey => {
                const date = new Date(dateKey);
                // Only count weekdays and non-holidays
                if (date.getDay() !== 0 && !holidays.has(dateKey) && attendance[dateKey].students) {
                    Object.values(attendance[dateKey].students).forEach(status => {
                        switch (status) {
                            case 'hadir': totalHadir++; break;
                            case 'sakit': totalSakit++; break;
                            case 'izin': totalIzin++; break;
                            case 'alpa': totalAlpa++; break;
                        }
                    });
                }
            });

            // Update the pie chart with animated segments
            updatePieChart(totalHadir, totalSakit, totalIzin, totalAlpa);
        }

        function updatePieChart(hadir, sakit, izin, alpa) {
            const total = hadir + sakit + izin + alpa;
            
            // Update count displays and percentages
            document.getElementById('totalCount').textContent = total;
            
            // Calculate and update percentages
            const hadirPercent = total > 0 ? ((hadir / total) * 100).toFixed(1) : 0;
            const sakitPercent = total > 0 ? ((sakit / total) * 100).toFixed(1) : 0;
            const izinPercent = total > 0 ? ((izin / total) * 100).toFixed(1) : 0;
            const alpaPercent = total > 0 ? ((alpa / total) * 100).toFixed(1) : 0;
            
            document.getElementById('hadirPercentage').textContent = hadirPercent + '%';
            document.getElementById('sakitPercentage').textContent = sakitPercent + '%';
            document.getElementById('izinPercentage').textContent = izinPercent + '%';
            document.getElementById('alpaPercentage').textContent = alpaPercent + '%';
            
            if (total === 0) {
                // Reset all segments to invisible
                ['segmentHadir', 'segmentSakit', 'segmentIzin', 'segmentAlpa'].forEach(id => {
                    const segment = document.getElementById(id);
                    segment.setAttribute('opacity', '0');
                    segment.setAttribute('stroke-dasharray', '0 314');
                });
                return;
            }
            
            const circumference = 2 * Math.PI * 50; // 2œÄr where r=50
            let currentOffset = 0;
            
            // Calculate percentages and create segments
            const segments = [
                { id: 'segmentHadir', value: hadir, color: '#22c55e' },
                { id: 'segmentSakit', value: sakit, color: '#3b82f6' },
                { id: 'segmentIzin', value: izin, color: '#eab308' },
                { id: 'segmentAlpa', value: alpa, color: '#ef4444' }
            ];
            
            // Reset all segments first
            segments.forEach(segment => {
                const element = document.getElementById(segment.id);
                element.setAttribute('opacity', '0');
                element.setAttribute('stroke-dasharray', '0 314');
                element.setAttribute('stroke-dashoffset', '0');
            });
            
            // Animate segments with delay
            setTimeout(() => {
                segments.forEach((segment, index) => {
                    if (segment.value > 0) {
                        const element = document.getElementById(segment.id);
                        const percentage = segment.value / total;
                        const segmentLength = circumference * percentage;
                        const gap = circumference - segmentLength;
                        
                        // Set segment properties
                        element.setAttribute('stroke-dasharray', `${segmentLength} ${gap}`);
                        element.setAttribute('stroke-dashoffset', -currentOffset);
                        
                        // Show segment with animation delay
                        setTimeout(() => {
                            element.setAttribute('opacity', '1');
                        }, index * 200);
                        
                        currentOffset += segmentLength;
                    }
                });
            }, 300);
        }

        function updateRecentActivity() {
            const recentActivityEl = document.getElementById('recentActivity');
            const recentDates = Object.keys(attendance)
                .filter(dateKey => attendance[dateKey].saved)
                .sort((a, b) => new Date(b) - new Date(a))
                .slice(0, 3);

            if (recentDates.length === 0) {
                recentActivityEl.innerHTML = '<p class="text-gray-500 text-center">Belum ada aktivitas</p>';
                return;
            }

            let html = '<div class="space-y-2">';
            recentDates.forEach(dateKey => {
                const date = new Date(dateKey);
                const attendanceData = attendance[dateKey];
                const totalPresent = Object.values(attendanceData.students).filter(status => status === 'hadir').length;
                const totalStudents = Object.keys(attendanceData.students).length;
                
                html += `
                    <div class="flex justify-between items-center p-2 bg-white rounded border">
                        <div>
                            <div class="font-semibold text-sm">${date.toLocaleDateString('id-ID')}</div>
                            <div class="text-xs text-gray-600">Absensi disimpan</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-semibold text-green-600">${totalPresent}/${totalStudents}</div>
                            <div class="text-xs text-gray-500">hadir</div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            recentActivityEl.innerHTML = html;
        }

        function quickAttendance() {
            // Set today's date and show attendance interface
            selectedAttendanceDate = new Date();
            updateSelectedDate();
            loadAttendanceTable();
            
            // Create attendance popup
            const popup = document.createElement('div');
            popup.id = 'attendancePopup';
            popup.className = 'fixed inset-0 bg-black bg-opacity-50 z-50';
            popup.innerHTML = `
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="bg-white rounded-lg p-6 w-full max-w-md max-h-[80vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-teal-700">‚úÖ ABSEN HARI INI</h3>
                            <button onclick="closeAttendancePopup()" class="text-gray-500 hover:text-gray-700">‚úï</button>
                        </div>
                        
                        <div class="mb-4 p-3 bg-teal-50 rounded">
                            <div class="text-center">
                                <span class="font-semibold text-teal-700">TANGGAL: </span>
                                <span class="font-bold">${selectedAttendanceDate.toLocaleDateString('id-ID')}</span>
                            </div>
                        </div>

                        <div class="flex justify-between items-center mb-4">
                            <button onclick="markAllPresentQuick()" class="bg-green-500 text-white px-3 py-2 rounded text-xs">‚úÖ HADIR SEMUA</button>
                            <button onclick="saveAttendanceQuick()" class="bg-blue-500 text-white px-3 py-2 rounded text-xs">üíæ SIMPAN</button>
                        </div>
                        
                        <div class="space-y-2" id="quickAttendanceList">
                            ${generateQuickAttendanceList()}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(popup);
        }

        function generateQuickAttendanceList() {
            const dateKey = selectedAttendanceDate.toDateString();
            let html = '';
            
            students.forEach((student, index) => {
                const studentAttendance = attendance[dateKey] && attendance[dateKey].students[student.id];
                const status = studentAttendance || '';
                
                html += `
                    <div class="border rounded p-3">
                        <div class="font-semibold text-sm mb-2">${index + 1}. ${student.name}</div>
                        <div class="flex gap-2">
                            <button onclick="setQuickAttendance(${student.id}, 'hadir')" 
                                    class="px-2 py-1 rounded text-xs text-white ${status === 'hadir' ? 'btn-hadir' : 'bg-gray-300'}">H</button>
                            <button onclick="setQuickAttendance(${student.id}, 'sakit')" 
                                    class="px-2 py-1 rounded text-xs text-white ${status === 'sakit' ? 'btn-sakit' : 'bg-gray-300'}">S</button>
                            <button onclick="setQuickAttendance(${student.id}, 'izin')" 
                                    class="px-2 py-1 rounded text-xs text-white ${status === 'izin' ? 'btn-izin' : 'bg-gray-300'}">I</button>
                            <button onclick="setQuickAttendance(${student.id}, 'alpa')" 
                                    class="px-2 py-1 rounded text-xs text-white ${status === 'alpa' ? 'btn-alpa' : 'bg-gray-300'}">A</button>
                        </div>
                    </div>
                `;
            });
            
            return html;
        }

        function setQuickAttendance(studentId, status) {
            // Play sound notification
            playSound(status);
            
            const dateKey = selectedAttendanceDate.toDateString();
            if (!attendance[dateKey]) {
                attendance[dateKey] = { students: {}, saved: false };
            }
            
            attendance[dateKey].students[studentId] = status;
            
            // Update the quick attendance list
            document.getElementById('quickAttendanceList').innerHTML = generateQuickAttendanceList();
            saveData();
        }

        function markAllPresentQuick() {
            // Play sound notification for marking all present
            playSound('hadir');
            
            const dateKey = selectedAttendanceDate.toDateString();
            if (!attendance[dateKey]) {
                attendance[dateKey] = { students: {}, saved: false };
            }
            
            students.forEach(student => {
                attendance[dateKey].students[student.id] = 'hadir';
            });
            
            document.getElementById('quickAttendanceList').innerHTML = generateQuickAttendanceList();
            saveData();
        }

        function saveAttendanceQuick() {
            const dateKey = selectedAttendanceDate.toDateString();
            if (attendance[dateKey]) {
                attendance[dateKey].saved = true;
                saveData();
                updateHomeStats();
                updateRecentActivity();
                
                // Play success sound
                playSound('save');
                
                alert('‚úÖ Absensi berhasil disimpan!');
                closeAttendancePopup();
            }
        }

        function closeAttendancePopup() {
            const popup = document.getElementById('attendancePopup');
            if (popup) {
                popup.remove();
            }
        }

        // Tab functions
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('[id^="tab-"]').forEach(tab => {
                tab.className = 'tab-inactive px-3 py-2 text-xs font-semibold whitespace-nowrap';
            });
            
            // Show selected tab
            document.getElementById('content-' + tabName).classList.remove('hidden');
            document.getElementById('tab-' + tabName).className = 'tab-active px-3 py-2 text-xs font-semibold whitespace-nowrap';
            
            // Load data for specific tabs
            if (tabName === 'home') {
                // Add delay to ensure DOM is ready
                setTimeout(() => {
                    updateHomeStats();
                    updateRecentActivity();
                }, 100);
            } else if (tabName === 'absen') {
                updateSelectedDate();
                loadAttendanceTable();
            } else if (tabName === 'riwayat') {
                loadHistory();
            } else if (tabName === 'statistik') {
                loadStatistics();
            }
        }

        // Student management
        function showAddStudentPopup() {
            document.getElementById('addStudentPopup').classList.remove('hidden');
            document.getElementById('studentName').value = '';
            document.getElementById('studentNIS').value = '';
            selectedGender = '';
            updateGenderButtons();
        }

        function closeAddStudentPopup() {
            document.getElementById('addStudentPopup').classList.add('hidden');
        }

        function selectGender(gender) {
            selectedGender = gender;
            updateGenderButtons();
        }

        function updateGenderButtons() {
            document.getElementById('genderL').className = selectedGender === 'L' ? 
                'flex-1 p-2 border rounded bg-blue-500 text-white' : 
                'flex-1 p-2 border rounded bg-gray-100';
            document.getElementById('genderP').className = selectedGender === 'P' ? 
                'flex-1 p-2 border rounded bg-pink-500 text-white' : 
                'flex-1 p-2 border rounded bg-gray-100';
        }

        function saveStudent() {
            const name = document.getElementById('studentName').value.trim();
            const nis = document.getElementById('studentNIS').value.trim();
            
            if (!name || !nis || !selectedGender) {
                alert('Mohon lengkapi semua data!');
                return;
            }

            // Check for duplicates
            const duplicate = students.find(student => 
                student.name.toLowerCase() === name.toLowerCase() || student.nis === nis
            );
            
            if (duplicate) {
                alert('Nama atau NIS sudah ada!');
                return;
            }

            students.push({
                id: Date.now(),
                name: name,
                nis: nis,
                gender: selectedGender
            });

            students.sort((a, b) => a.name.localeCompare(b.name));
            updateStudentCount();
            loadStudentTable();
            loadAttendanceTable();
            updateHomeStats();
            
            // Update diagram in real-time
            updateOverallStatistics();
            
            saveData();
            
            // Play success sound
            playSound('save');
            
            closeAddStudentPopup();
        }

        function editStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            currentEditingStudent = studentId;
            document.getElementById('editStudentName').value = student.name;
            document.getElementById('editStudentNIS').value = student.nis;
            selectedEditGender = student.gender;
            updateEditGenderButtons();
            document.getElementById('editStudentPopup').classList.remove('hidden');
        }

        function selectEditGender(gender) {
            selectedEditGender = gender;
            updateEditGenderButtons();
        }

        function updateEditGenderButtons() {
            document.getElementById('editGenderL').className = selectedEditGender === 'L' ? 
                'flex-1 p-2 border rounded bg-blue-500 text-white' : 
                'flex-1 p-2 border rounded bg-gray-100';
            document.getElementById('editGenderP').className = selectedEditGender === 'P' ? 
                'flex-1 p-2 border rounded bg-pink-500 text-white' : 
                'flex-1 p-2 border rounded bg-gray-100';
        }

        function updateStudent() {
            const name = document.getElementById('editStudentName').value.trim();
            const nis = document.getElementById('editStudentNIS').value.trim();
            
            if (!name || !nis || !selectedEditGender) {
                alert('Mohon lengkapi semua data!');
                return;
            }

            // Check for duplicates (excluding current student)
            const duplicate = students.find(student => 
                student.id !== currentEditingStudent && 
                (student.name.toLowerCase() === name.toLowerCase() || student.nis === nis)
            );
            
            if (duplicate) {
                alert('Nama atau NIS sudah ada!');
                return;
            }

            const studentIndex = students.findIndex(s => s.id === currentEditingStudent);
            if (studentIndex !== -1) {
                students[studentIndex] = {
                    ...students[studentIndex],
                    name: name,
                    nis: nis,
                    gender: selectedEditGender
                };
                
                students.sort((a, b) => a.name.localeCompare(b.name));
                loadStudentTable();
                loadAttendanceTable();
                updateHomeStats();
                
                // Update diagram in real-time
                updateOverallStatistics();
                
                saveData();
                
                // Play success sound
                playSound('save');
            }
            
            closeEditStudentPopup();
        }

        function deleteStudent() {
            if (confirm('Yakin ingin menghapus siswa ini?')) {
                students = students.filter(s => s.id !== currentEditingStudent);
                updateStudentCount();
                loadStudentTable();
                loadAttendanceTable();
                updateHomeStats();
                
                // Update diagram in real-time
                updateOverallStatistics();
                
                saveData();
                closeEditStudentPopup();
            }
        }

        function closeEditStudentPopup() {
            document.getElementById('editStudentPopup').classList.add('hidden');
            currentEditingStudent = null;
        }

        function updateStudentCount() {
            // Function kept for compatibility but no longer updates display
            // Student count is now shown in the Quick Stats section
        }

        // School Info Management Functions
        function updateSchoolInfoDisplay(schoolInfo = null) {
            // Get school info from parameter or localStorage
            if (!schoolInfo) {
                const savedData = localStorage.getItem('absenSiswaData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    schoolInfo = data.schoolInfo || {};
                } else {
                    schoolInfo = {};
                }
            }
            
            // Update display elements
            document.getElementById('displayNamaSekolah').textContent = schoolInfo.namaSekolah || 'Belum diisi';
            document.getElementById('displayKelas').textContent = schoolInfo.kelas || 'Belum diisi';
            document.getElementById('displayWaliKelas').textContent = schoolInfo.waliKelas || 'Belum diisi';
        }

        function showSchoolInfoPopup() {
            // Load current data into popup
            const savedData = localStorage.getItem('absenSiswaData');
            let schoolInfo = {};
            
            if (savedData) {
                const data = JSON.parse(savedData);
                schoolInfo = data.schoolInfo || {};
            }
            
            // Fill popup fields
            document.getElementById('editNamaSekolah').value = schoolInfo.namaSekolah || '';
            document.getElementById('editKelas').value = schoolInfo.kelas || '';
            document.getElementById('editWaliKelas').value = schoolInfo.waliKelas || '';
            
            // Show popup
            document.getElementById('schoolInfoPopup').classList.remove('hidden');
        }

        function closeSchoolInfoPopup() {
            document.getElementById('schoolInfoPopup').classList.add('hidden');
        }

        function saveSchoolInfo() {
            // Get values from popup
            const schoolInfo = {
                namaSekolah: document.getElementById('editNamaSekolah').value.trim(),
                kelas: document.getElementById('editKelas').value.trim(),
                waliKelas: document.getElementById('editWaliKelas').value.trim()
            };
            
            // Save to localStorage
            try {
                const savedData = localStorage.getItem('absenSiswaData');
                let data = {};
                
                if (savedData) {
                    data = JSON.parse(savedData);
                }
                
                data.schoolInfo = schoolInfo;
                data.lastSaved = new Date().toISOString();
                
                localStorage.setItem('absenSiswaData', JSON.stringify(data));
                
                // Update display
                updateSchoolInfoDisplay(schoolInfo);
                
                // Close popup
                closeSchoolInfoPopup();
                
                // Show success message
                updateAutosaveStatus('TERSIMPAN');
                
                // Play success sound
                playSound('save');
                
                alert('‚úÖ Informasi sekolah berhasil disimpan!');
                
            } catch (error) {
                console.error('Error saving school info:', error);
                alert('‚ùå Gagal menyimpan informasi sekolah!');
            }
        }

        function loadStudentTable() {
            const tbody = document.getElementById('studentTableBody');
            tbody.innerHTML = '';
            
            students.forEach((student, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td class="border border-teal-300 p-2 text-center bg-teal-50 text-teal-800">${index + 1}</td>
                    <td class="border border-teal-300 p-2 bg-teal-50 text-teal-800">${student.name}</td>
                    <td class="border border-teal-300 p-2 text-center bg-teal-50 text-teal-800">${student.nis}</td>
                    <td class="border border-teal-300 p-2 text-center bg-teal-50 text-teal-800">${student.gender}</td>
                    <td class="border border-teal-300 p-2 text-center bg-teal-50">
                        <button onclick="editStudent(${student.id})" class="bg-orange-500 text-white px-2 py-1 rounded text-xs">EDIT</button>
                    </td>
                `;
            });
        }

        // Calendar functions
        function showCalendarPopup() {
            document.getElementById('calendarPopup').classList.remove('hidden');
            updateCalendar();
        }

        function closeCalendarPopup() {
            document.getElementById('calendarPopup').classList.add('hidden');
        }

        function updateCalendar() {
            const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                              'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            
            document.getElementById('calendarMonthYear').textContent = 
                `${monthNames[currentCalendarDate.getMonth()]} ${currentCalendarDate.getFullYear()}`;
            
            const firstDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
            const lastDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = '';
            
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayButton = document.createElement('button');
                dayButton.textContent = date.getDate();
                dayButton.className = 'p-2 text-xs border rounded hover:bg-teal-100';
                
                if (date.getMonth() !== currentCalendarDate.getMonth()) {
                    dayButton.className += ' text-gray-400';
                }
                
                // Check if this is today's date
                const today = new Date();
                const isToday = date.getDate() === today.getDate() && 
                               date.getMonth() === today.getMonth() && 
                               date.getFullYear() === today.getFullYear();
                
                if (isToday) {
                    dayButton.className += ' bg-green-700 text-white font-bold';
                } else if (date.getDay() === 0) {
                    dayButton.className += ' bg-purple-100 text-purple-700';
                }
                
                const dateKey = date.toDateString();
                if (holidays.has(dateKey) && !isToday) {
                    dayButton.className += ' bg-yellow-200 text-yellow-800';
                }
                
                dayButton.onclick = () => selectDate(date);
                calendarDays.appendChild(dayButton);
            }
        }

        function changeMonth(direction) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            updateCalendar();
        }

        function selectDate(date) {
            selectedAttendanceDate = new Date(date);
            updateSelectedDate();
            loadAttendanceTable();
            closeCalendarPopup();
        }

        // Holiday functions
        function checkHolidayStatus() {
            const dateKey = selectedAttendanceDate.toDateString();
            const isSunday = selectedAttendanceDate.getDay() === 0;
            const isHoliday = holidays.has(dateKey);
            
            if (isSunday || isHoliday) {
                document.getElementById('attendanceContent').classList.add('hidden');
                document.getElementById('holidayContent').classList.remove('hidden');
                
                const holidayDisplay = document.getElementById('holidayDisplay');
                if (isSunday) {
                    holidayDisplay.className = 'holiday-display sunday-holiday';
                    holidayDisplay.innerHTML = `
                        <div class="flex flex-col items-center">
                            <svg width="80" height="80" viewBox="0 0 100 100" class="mb-4 animate-pulse">
                                <!-- Sun rays -->
                                <g stroke="#FCD34D" stroke-width="3" stroke-linecap="round">
                                    <line x1="50" y1="10" x2="50" y2="20"/>
                                    <line x1="50" y1="80" x2="50" y2="90"/>
                                    <line x1="10" y1="50" x2="20" y2="50"/>
                                    <line x1="80" y1="50" x2="90" y2="50"/>
                                    <line x1="21.21" y1="21.21" x2="28.28" y2="28.28"/>
                                    <line x1="71.72" y1="71.72" x2="78.79" y2="78.79"/>
                                    <line x1="21.21" y1="78.79" x2="28.28" y2="71.72"/>
                                    <line x1="71.72" y1="28.28" x2="78.79" y2="21.21"/>
                                </g>
                                <!-- Sun face -->
                                <circle cx="50" cy="50" r="25" fill="#FCD34D" stroke="#F59E0B" stroke-width="2"/>
                                <!-- Eyes -->
                                <circle cx="42" cy="42" r="3" fill="#1F2937"/>
                                <circle cx="58" cy="42" r="3" fill="#1F2937"/>
                                <!-- Smile -->
                                <path d="M 38 58 Q 50 68 62 58" stroke="#1F2937" stroke-width="2" fill="none" stroke-linecap="round"/>
                                <!-- Cheeks -->
                                <circle cx="32" cy="52" r="4" fill="#F97316" opacity="0.6"/>
                                <circle cx="68" cy="52" r="4" fill="#F97316" opacity="0.6"/>
                            </svg>
                            <h3 class="text-2xl font-bold mb-2">HARI MINGGU</h3>
                            <p class="text-lg mb-2">TIDAK ADA ABSENSI YANG BISA DI ISI DI HARI LIBUR</p>
                            <p class="text-sm opacity-90">${selectedAttendanceDate.toLocaleDateString('id-ID')}</p>
                        </div>
                    `;
                } else {
                    holidayDisplay.className = 'holiday-display';
                    holidayDisplay.style.background = 'linear-gradient(135deg, #87CEEB, #4682B4)';
                    holidayDisplay.innerHTML = `
                        <div class="flex flex-col items-center">
                            <svg width="100" height="100" viewBox="0 0 120 120" class="mb-4 animate-bounce">
                                <!-- Sun rays -->
                                <g stroke="#FCD34D" stroke-width="4" stroke-linecap="round">
                                    <line x1="60" y1="15" x2="60" y2="25"/>
                                    <line x1="60" y1="95" x2="60" y2="105"/>
                                    <line x1="15" y1="60" x2="25" y2="60"/>
                                    <line x1="95" y1="60" x2="105" y2="60"/>
                                    <line x1="25.86" y1="25.86" x2="32.93" y2="32.93"/>
                                    <line x1="87.07" y1="87.07" x2="94.14" y2="94.14"/>
                                    <line x1="25.86" y1="94.14" x2="32.93" y2="87.07"/>
                                    <line x1="87.07" y1="32.93" x2="94.14" y2="25.86"/>
                                </g>
                                <!-- Sun body -->
                                <circle cx="60" cy="60" r="30" fill="#FCD34D" stroke="#F59E0B" stroke-width="3"/>
                                
                                <!-- Sunglasses frame -->
                                <rect x="35" y="48" width="50" height="20" rx="10" fill="none" stroke="#1F2937" stroke-width="3"/>
                                <!-- Left lens -->
                                <circle cx="45" cy="58" r="12" fill="#1F2937" opacity="0.8"/>
                                <!-- Right lens -->
                                <circle cx="75" cy="58" r="12" fill="#1F2937" opacity="0.8"/>
                                <!-- Bridge -->
                                <line x1="57" y1="58" x2="63" y2="58" stroke="#1F2937" stroke-width="3"/>
                                <!-- Left temple -->
                                <line x1="33" y1="58" x2="25" y2="55" stroke="#1F2937" stroke-width="3"/>
                                <!-- Right temple -->
                                <line x1="87" y1="58" x2="95" y2="55" stroke="#1F2937" stroke-width="3"/>
                                
                                <!-- Cool smile -->
                                <path d="M 42 75 Q 60 85 78 75" stroke="#1F2937" stroke-width="3" fill="none" stroke-linecap="round"/>
                                
                                <!-- Cheeks -->
                                <circle cx="35" cy="68" r="5" fill="#F97316" opacity="0.6"/>
                                <circle cx="85" cy="68" r="5" fill="#F97316" opacity="0.6"/>
                            </svg>
                            <h3 class="text-2xl font-bold mb-2">HARI LIBUR</h3>
                            <p class="text-lg mb-2">NIKMATI HARI LIBUR MU</p>
                            <p class="text-sm opacity-90">${selectedAttendanceDate.toLocaleDateString('id-ID')}</p>
                        </div>
                    `;
                }
                
                document.getElementById('holidayBtn').textContent = '‚ùå BATAL LIBUR';
                document.getElementById('holidayBtn').className = 'bg-red-500 text-white px-3 py-2 rounded text-xs';
            } else {
                document.getElementById('attendanceContent').classList.remove('hidden');
                document.getElementById('holidayContent').classList.add('hidden');
                document.getElementById('holidayBtn').textContent = 'üèñÔ∏è LIBUR';
                document.getElementById('holidayBtn').className = 'bg-yellow-500 text-white px-3 py-2 rounded text-xs';
            }
        }

        function toggleHoliday() {
            const dateKey = selectedAttendanceDate.toDateString();
            const isSunday = selectedAttendanceDate.getDay() === 0;
            
            if (isSunday) {
                alert('Hari Minggu adalah hari libur tetap!');
                return;
            }
            
            if (holidays.has(dateKey)) {
                holidays.delete(dateKey);
            } else {
                holidays.add(dateKey);
            }
            
            checkHolidayStatus();
            loadAttendanceTable();
            
            // Update diagram in real-time
            updateOverallStatistics();
            
            saveData();
        }

        // Attendance functions
        function loadAttendanceTable() {
            const tbody = document.getElementById('attendanceTableBody');
            tbody.innerHTML = '';
            
            const dateKey = selectedAttendanceDate.toDateString();
            attendanceSaved = attendance[dateKey] && attendance[dateKey].saved;
            
            updateAttendanceButtons();
            
            students.forEach((student, index) => {
                const row = tbody.insertRow();
                const studentAttendance = attendance[dateKey] && attendance[dateKey].students[student.id];
                const status = studentAttendance || '';
                
                row.innerHTML = `
                    <td class="border border-teal-300 p-2 text-center bg-teal-50 text-teal-800">${index + 1}</td>
                    <td class="border border-teal-300 p-2 bg-teal-50 text-teal-800">${student.name}</td>
                    <td class="border border-teal-300 p-2 text-center bg-teal-50">
                        <div class="flex flex-wrap gap-1">
                            <button onclick="setAttendance(${student.id}, 'hadir')" 
                                    class="px-2 py-1 rounded text-xs text-white ${status === 'hadir' ? 'btn-hadir' : 'bg-gray-300'}" 
                                    ${attendanceSaved ? 'disabled' : ''}>H</button>
                            <button onclick="setAttendance(${student.id}, 'sakit')" 
                                    class="px-2 py-1 rounded text-xs text-white ${status === 'sakit' ? 'btn-sakit' : 'bg-gray-300'}" 
                                    ${attendanceSaved ? 'disabled' : ''}>S</button>
                            <button onclick="setAttendance(${student.id}, 'izin')" 
                                    class="px-2 py-1 rounded text-xs text-white ${status === 'izin' ? 'btn-izin' : 'bg-gray-300'}" 
                                    ${attendanceSaved ? 'disabled' : ''}>I</button>
                            <button onclick="setAttendance(${student.id}, 'alpa')" 
                                    class="px-2 py-1 rounded text-xs text-white ${status === 'alpa' ? 'btn-alpa' : 'bg-gray-300'}" 
                                    ${attendanceSaved ? 'disabled' : ''}>A</button>
                        </div>
                    </td>
                `;
            });
        }

        function updateAttendanceButtons() {
            const saveBtn = document.getElementById('saveBtn');
            const editBtn = document.getElementById('editBtn');
            
            if (attendanceSaved) {
                saveBtn.textContent = '‚úÖ TERSIMPAN';
                saveBtn.className = 'bg-green-600 text-white px-3 py-2 rounded text-xs';
                saveBtn.disabled = true;
                editBtn.classList.remove('hidden');
            } else {
                saveBtn.textContent = 'üíæ SIMPAN';
                saveBtn.className = 'bg-blue-500 text-white px-3 py-2 rounded text-xs';
                saveBtn.disabled = false;
                editBtn.classList.add('hidden');
            }
        }

        function setAttendance(studentId, status) {
            if (attendanceSaved) return;
            
            // Play sound notification
            playSound(status);
            
            const dateKey = selectedAttendanceDate.toDateString();
            if (!attendance[dateKey]) {
                attendance[dateKey] = { students: {}, saved: false };
            }
            
            attendance[dateKey].students[studentId] = status;
            loadAttendanceTable();
            
            // Update diagram in real-time
            updateOverallStatistics();
            
            saveData();
        }

        function markAllPresent() {
            if (attendanceSaved) return;
            
            // Play sound notification for marking all present
            playSound('hadir');
            
            const dateKey = selectedAttendanceDate.toDateString();
            if (!attendance[dateKey]) {
                attendance[dateKey] = { students: {}, saved: false };
            }
            
            students.forEach(student => {
                attendance[dateKey].students[student.id] = 'hadir';
            });
            
            loadAttendanceTable();
            
            // Update diagram in real-time
            updateOverallStatistics();
            
            saveData();
        }

        function saveAttendance() {
            const dateKey = selectedAttendanceDate.toDateString();
            if (attendance[dateKey]) {
                attendance[dateKey].saved = true;
                attendanceSaved = true;
                updateAttendanceButtons();
                loadAttendanceTable();
                saveData();
                
                // Update home stats and chart
                updateHomeStats();
                
                // Play success sound
                playSound('save');
                
                alert('‚úÖ Absensi berhasil disimpan!');
            }
        }

        function editAttendance() {
            const dateKey = selectedAttendanceDate.toDateString();
            if (attendance[dateKey]) {
                attendance[dateKey].saved = false;
                attendanceSaved = false;
                updateAttendanceButtons();
                loadAttendanceTable();
                
                // Update diagram in real-time
                updateOverallStatistics();
                
                saveData();
            }
        }

        // History functions
        function loadHistory() {
            const month = parseInt(document.getElementById('monthSelect').value);
            const year = parseInt(document.getElementById('yearSelect').value);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Update header
            const header = document.getElementById('historyHeader');
            header.innerHTML = '<th class="border border-teal-300 p-1 sticky left-0 bg-teal-200 z-10 text-teal-800">NO</th><th class="border border-teal-300 p-1 sticky left-8 bg-teal-200 z-10 text-teal-800">NAMA</th>';
            
            for (let day = 1; day <= daysInMonth; day++) {
                header.innerHTML += `<th class="border border-teal-300 p-1 text-xs bg-teal-200 text-teal-800">${day}</th>`;
            }
            
            // Update body
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = '';
            
            students.forEach((student, index) => {
                const row = tbody.insertRow();
                
                // Add alternating row colors
                const isEven = index % 2 === 0;
                const rowBgClass = isEven ? 'bg-teal-100' : 'bg-teal-50';
                row.className = rowBgClass;
                
                let rowHTML = `
                    <td class="border border-teal-300 p-1 text-center sticky left-0 ${rowBgClass} z-10 text-teal-800">${index + 1}</td>
                    <td class="border border-teal-300 p-1 text-xs sticky left-8 ${rowBgClass} z-10 text-teal-800">${student.name}</td>
                `;
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dateKey = date.toDateString();
                    let cellContent = '-';
                    let cellClass = 'border border-teal-300 p-1 text-center text-xs text-teal-800';
                    
                    if (date.getDay() === 0) {
                        cellContent = 'M';
                        cellClass += ' bg-purple-200';
                    } else if (holidays.has(dateKey)) {
                        cellContent = 'L';
                        cellClass += ' bg-yellow-200';
                    } else if (attendance[dateKey] && attendance[dateKey].students[student.id]) {
                        const status = attendance[dateKey].students[student.id];
                        switch (status) {
                            case 'hadir': cellContent = 'H'; cellClass += ' bg-green-200'; break;
                            case 'sakit': cellContent = 'S'; cellClass += ' bg-blue-200'; break;
                            case 'izin': cellContent = 'I'; cellClass += ' bg-yellow-200'; break;
                            case 'alpa': cellContent = 'A'; cellClass += ' bg-red-200'; break;
                        }
                    } else {
                        cellClass += ` ${rowBgClass}`;
                    }
                    
                    rowHTML += `<td class="${cellClass}">${cellContent}</td>`;
                }
                
                row.innerHTML = rowHTML;
            });
        }

        // Statistics functions
        function loadStatistics() {
            const monthValue = document.getElementById('statMonth').value;
            const yearValue = document.getElementById('statYear').value;
            const content = document.getElementById('statistikContent');
            
            if (students.length === 0) {
                content.innerHTML = '<p class="text-center text-gray-500">Belum ada data siswa</p>';
                return;
            }

            let html = '<div class="overflow-x-auto max-h-96 overflow-y-auto border border-teal-300 rounded">';
            html += '<table class="w-full border border-teal-300 text-sm bg-teal-50">';
            html += '<thead class="bg-teal-200">';
            html += '<tr><th class="border border-teal-300 p-2 text-teal-800">NO</th><th class="border border-teal-300 p-2 text-teal-800">NAMA</th><th class="border border-teal-300 p-2 text-teal-800">HADIR</th><th class="border border-teal-300 p-2 text-teal-800">SAKIT</th><th class="border border-teal-300 p-2 text-teal-800">IZIN</th><th class="border border-teal-300 p-2 text-teal-800">ALPA</th><th class="border border-teal-300 p-2 text-teal-800">%</th></tr>';
            html += '</thead><tbody>';

            students.forEach((student, index) => {
                let hadir = 0, sakit = 0, izin = 0, alpa = 0;
                
                Object.keys(attendance).forEach(dateKey => {
                    const date = new Date(dateKey);
                    let includeDate = true;
                    
                    if (monthValue !== 'all' && date.getMonth() !== parseInt(monthValue)) {
                        includeDate = false;
                    }
                    if (yearValue !== 'all' && date.getFullYear() !== parseInt(yearValue)) {
                        includeDate = false;
                    }
                    
                    if (includeDate && date.getDay() !== 0 && !holidays.has(dateKey)) {
                        const studentAttendance = attendance[dateKey] && attendance[dateKey].students[student.id];
                        switch (studentAttendance) {
                            case 'hadir': hadir++; break;
                            case 'sakit': sakit++; break;
                            case 'izin': izin++; break;
                            case 'alpa': alpa++; break;
                        }
                    }
                });
                
                const total = hadir + sakit + izin + alpa;
                const percentage = total > 0 ? ((hadir / total) * 100).toFixed(1) : 0;
                
                html += `<tr>
                    <td class="border border-teal-300 p-2 text-center bg-teal-50 text-teal-800">${index + 1}</td>
                    <td class="border border-teal-300 p-2 bg-teal-50 text-teal-800">${student.name}</td>
                    <td class="border border-teal-300 p-2 text-center bg-green-100 text-green-800">${hadir}</td>
                    <td class="border border-teal-300 p-2 text-center bg-blue-100 text-blue-800">${sakit}</td>
                    <td class="border border-teal-300 p-2 text-center bg-yellow-100 text-yellow-800">${izin}</td>
                    <td class="border border-teal-300 p-2 text-center bg-red-100 text-red-800">${alpa}</td>
                    <td class="border border-teal-300 p-2 text-center font-bold bg-teal-100 text-teal-800">${percentage}%</td>
                </tr>`;
            });

            html += '</tbody></table></div>';
            content.innerHTML = html;
        }

        // Upload functions
        function showUploadPopup() {
            document.getElementById('uploadPopup').classList.remove('hidden');
        }

        function closeUploadPopup() {
            document.getElementById('uploadPopup').classList.add('hidden');
            document.getElementById('fileInput').value = '';
            document.getElementById('replaceData').checked = false;
        }

        function processUpload() {
            const fileInput = document.getElementById('fileInput');
            const replaceData = document.getElementById('replaceData').checked;
            
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('Pilih file terlebih dahulu!');
                return;
            }
            
            const file = fileInput.files[0];
            const fileName = file.name.toLowerCase();
            
            if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                processExcelFile(file, replaceData);
            } else if (fileName.endsWith('.csv')) {
                processCSVFile(file, replaceData);
            } else if (fileName.endsWith('.txt')) {
                processTextFile(file, replaceData);
            } else {
                alert('Format file tidak didukung!');
            }
        }

        function processExcelFile(file, replaceData) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    processUploadedData(jsonData, replaceData);
                } catch (error) {
                    alert('Error membaca file Excel: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function processCSVFile(file, replaceData) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n');
                    const data = lines.map(line => line.split(',').map(cell => cell.trim()));
                    processUploadedData(data, replaceData);
                } catch (error) {
                    alert('Error membaca file CSV: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function processTextFile(file, replaceData) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n');
                    const data = lines.map(line => {
                        if (line.includes('\t')) {
                            return line.split('\t').map(cell => cell.trim());
                        } else if (line.includes('|')) {
                            return line.split('|').map(cell => cell.trim());
                        } else {
                            return line.split(',').map(cell => cell.trim());
                        }
                    });
                    processUploadedData(data, replaceData);
                } catch (error) {
                    alert('Error membaca file text: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function processUploadedData(data, replaceData) {
            try {
                const validData = data.filter(row => row && row.length >= 3 && row[0] && row[1] && row[2]);
                
                if (validData.length === 0) {
                    alert('File tidak berisi data yang valid!');
                    return;
                }
                
                let startIndex = 0;
                const firstRow = validData[0];
                if (firstRow[0].toString().toLowerCase().includes('nama')) {
                    startIndex = 1;
                }
                
                const newStudents = [];
                let successCount = 0;
                let errorCount = 0;
                
                for (let i = startIndex; i < validData.length; i++) {
                    const row = validData[i];
                    const name = row[0] ? row[0].toString().trim() : '';
                    const nis = row[1] ? row[1].toString().trim() : '';
                    const gender = row[2] ? row[2].toString().trim().toUpperCase() : '';
                    
                    if (!name || !nis || (!gender.startsWith('L') && !gender.startsWith('P'))) {
                        errorCount++;
                        continue;
                    }
                    
                    const normalizedGender = gender.startsWith('L') ? 'L' : 'P';
                    
                    if (!replaceData) {
                        const duplicate = students.find(student => 
                            student.name.toLowerCase() === name.toLowerCase() || student.nis === nis
                        );
                        if (duplicate) {
                            errorCount++;
                            continue;
                        }
                    }
                    
                    const duplicateInNew = newStudents.find(student => 
                        student.name.toLowerCase() === name.toLowerCase() || student.nis === nis
                    );
                    if (duplicateInNew) {
                        errorCount++;
                        continue;
                    }
                    
                    newStudents.push({
                        id: Date.now() + Math.random(),
                        name: name,
                        nis: nis,
                        gender: normalizedGender
                    });
                    successCount++;
                }
                
                if (newStudents.length === 0) {
                    alert('Tidak ada data valid untuk diimport!');
                    return;
                }
                
                if (replaceData) {
                    students = newStudents;
                } else {
                    students = students.concat(newStudents);
                }
                
                students.sort((a, b) => a.name.localeCompare(b.name));
                updateStudentCount();
                loadStudentTable();
                loadAttendanceTable();
                
                // Update diagram in real-time
                updateOverallStatistics();
                
                saveData();
                
                alert(`Upload berhasil!\nBerhasil: ${successCount} siswa\nDiabaikan: ${errorCount} baris`);
                closeUploadPopup();
                
            } catch (error) {
                alert('Error memproses data: ' + error.message);
            }
        }

        // Excel options toggle function
        function toggleExcelOptions(type) {
            const optionsId = type + 'ExcelOptions';
            const arrowId = type + 'Arrow';
            const options = document.getElementById(optionsId);
            const arrow = document.getElementById(arrowId);
            
            if (options.classList.contains('hidden')) {
                options.classList.remove('hidden');
                arrow.textContent = '‚ñ≤';
            } else {
                options.classList.add('hidden');
                arrow.textContent = '‚ñº';
            }
        }

        // Close Excel options when clicking outside
        document.addEventListener('click', function(event) {
            const historyOptions = document.getElementById('historyExcelOptions');
            const rekapOptions = document.getElementById('rekapExcelOptions');
            
            if (!event.target.closest('.relative')) {
                if (historyOptions && !historyOptions.classList.contains('hidden')) {
                    historyOptions.classList.add('hidden');
                    document.getElementById('historyArrow').textContent = '‚ñº';
                }
                if (rekapOptions && !rekapOptions.classList.contains('hidden')) {
                    rekapOptions.classList.add('hidden');
                    document.getElementById('rekapArrow').textContent = '‚ñº';
                }
            }
        });

        // Download functions
        function downloadHistory(format) {
            if (students.length === 0) {
                alert('Belum ada data siswa!');
                return;
            }

            const monthValue = document.getElementById('downloadMonth').value;
            const yearValue = document.getElementById('downloadYear').value;
            
            const reportData = generateHistoryReport(monthValue, yearValue);
            
            // Close dropdown after selection
            const historyOptions = document.getElementById('historyExcelOptions');
            if (historyOptions && !historyOptions.classList.contains('hidden')) {
                historyOptions.classList.add('hidden');
                document.getElementById('historyArrow').textContent = '‚ñº';
            }
            
            if (format === 'xlsx' || format === 'xls' || format === 'csv' || format === 'ods') {
                downloadExcel(reportData, 'Riwayat_Kehadiran', format);
            } else if (format === 'pdf') {
                downloadPDF(reportData, 'Riwayat_Kehadiran');
            }
        }

        function downloadRekap(format) {
            if (students.length === 0) {
                alert('Belum ada data siswa!');
                return;
            }

            const monthValue = document.getElementById('rekapMonth').value;
            const yearValue = document.getElementById('rekapYear').value;
            
            const reportData = generateRekapReport(monthValue, yearValue);
            
            // Close dropdown after selection
            const rekapOptions = document.getElementById('rekapExcelOptions');
            if (rekapOptions && !rekapOptions.classList.contains('hidden')) {
                rekapOptions.classList.add('hidden');
                document.getElementById('rekapArrow').textContent = '‚ñº';
            }
            
            if (format === 'xlsx' || format === 'xls' || format === 'csv' || format === 'ods') {
                downloadExcel(reportData, 'Rekap_Kehadiran', format);
            } else if (format === 'pdf') {
                downloadPDF(reportData, 'Rekap_Kehadiran');
            }
        }

        function generateHistoryReport(monthValue, yearValue) {
            const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                              'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            
            // If specific month and year selected
            if (monthValue !== 'all' && yearValue !== 'all') {
                const month = parseInt(monthValue);
                const year = parseInt(yearValue);
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                const dates = [];
                for (let day = 1; day <= daysInMonth; day++) {
                    dates.push(new Date(year, month, day));
                }
                
                const headers = ['NO', 'NAMA SISWA', 'NIS'];
                for (let day = 1; day <= daysInMonth; day++) {
                    headers.push(day.toString());
                }
                headers.push('HADIR', 'SAKIT', 'IZIN', 'ALPA');

                const rows = [];
                students.forEach((student, index) => {
                    const row = [index + 1, student.name, student.nis];
                    let hadir = 0, sakit = 0, izin = 0, alpa = 0;
                    
                    dates.forEach(date => {
                        const dateKey = date.toDateString();
                        let status = '-';
                        
                        if (date.getDay() === 0) {
                            status = 'M';
                        } else if (holidays.has(dateKey)) {
                            status = 'L';
                        } else if (attendance[dateKey] && attendance[dateKey].students[student.id]) {
                            const studentAttendance = attendance[dateKey].students[student.id];
                            switch (studentAttendance) {
                                case 'hadir': status = 'H'; hadir++; break;
                                case 'sakit': status = 'S'; sakit++; break;
                                case 'izin': status = 'I'; izin++; break;
                                case 'alpa': status = 'A'; alpa++; break;
                            }
                        }
                        
                        row.push(status);
                    });
                    
                    row.push(hadir, sakit, izin, alpa);
                    rows.push(row);
                });

                return {
                    title: `RIWAYAT ABSENSI ${monthNames[month]} ${year}`,
                    headers: headers,
                    rows: rows,
                    isMultiMonth: false
                };
            } 
            // If all months and all years (multi-month format)
            else {
                // Get all unique months/years from attendance data
                const monthYearSet = new Set();
                Object.keys(attendance).forEach(dateKey => {
                    const date = new Date(dateKey);
                    if (monthValue === 'all' || date.getMonth() === parseInt(monthValue)) {
                        if (yearValue === 'all' || date.getFullYear() === parseInt(yearValue)) {
                            const monthYear = `${date.getFullYear()}-${date.getMonth()}`;
                            monthYearSet.add(monthYear);
                        }
                    }
                });

                const monthYears = Array.from(monthYearSet).sort();
                const sections = [];

                monthYears.forEach(monthYear => {
                    const [year, month] = monthYear.split('-').map(Number);
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    
                    const dates = [];
                    for (let day = 1; day <= daysInMonth; day++) {
                        dates.push(new Date(year, month, day));
                    }
                    
                    const headers = ['NO', 'NAMA SISWA', 'NIS'];
                    for (let day = 1; day <= daysInMonth; day++) {
                        headers.push(day.toString());
                    }
                    headers.push('HADIR', 'SAKIT', 'IZIN', 'ALPA');

                    const rows = [];
                    students.forEach((student, index) => {
                        const row = [index + 1, student.name, student.nis];
                        let hadir = 0, sakit = 0, izin = 0, alpa = 0;
                        
                        dates.forEach(date => {
                            const dateKey = date.toDateString();
                            let status = '-';
                            
                            if (date.getDay() === 0) {
                                status = 'M';
                            } else if (holidays.has(dateKey)) {
                                status = 'L';
                            } else if (attendance[dateKey] && attendance[dateKey].students[student.id]) {
                                const studentAttendance = attendance[dateKey].students[student.id];
                                switch (studentAttendance) {
                                    case 'hadir': status = 'H'; hadir++; break;
                                    case 'sakit': status = 'S'; sakit++; break;
                                    case 'izin': status = 'I'; izin++; break;
                                    case 'alpa': status = 'A'; alpa++; break;
                                }
                            }
                            
                            row.push(status);
                        });
                        
                        row.push(hadir, sakit, izin, alpa);
                        rows.push(row);
                    });

                    sections.push({
                        title: `${monthNames[month]} ${year}`,
                        headers: headers,
                        rows: rows
                    });
                });

                let periodText = '';
                if (monthValue !== 'all' && yearValue === 'all') {
                    periodText = `${monthNames[parseInt(monthValue)]} SEMUA TAHUN`;
                } else if (monthValue === 'all' && yearValue !== 'all') {
                    periodText = `SEMUA BULAN ${yearValue}`;
                } else {
                    periodText = 'SEMUA DATA';
                }

                return {
                    title: `RIWAYAT ABSENSI ${periodText}`,
                    sections: sections,
                    isMultiMonth: true
                };
            }
        }

        function generateRekapReport(monthValue, yearValue) {
            const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                              'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            
            let periodText = '';
            if (monthValue !== 'all' && yearValue !== 'all') {
                periodText = `${monthNames[parseInt(monthValue)]} ${yearValue}`;
            } else if (monthValue !== 'all' && yearValue === 'all') {
                periodText = `${monthNames[parseInt(monthValue)]} Semua Tahun`;
            } else if (monthValue === 'all' && yearValue !== 'all') {
                periodText = `Semua Bulan ${yearValue}`;
            } else {
                periodText = 'Semua Data';
            }

            const headers = ['NO', 'NAMA SISWA', 'NIS', 'HADIR', 'SAKIT', 'IZIN', 'ALPA', 'PERSENTASE'];
            const rows = [];

            students.forEach((student, index) => {
                let hadir = 0, sakit = 0, izin = 0, alpa = 0;
                
                Object.keys(attendance).forEach(dateKey => {
                    const date = new Date(dateKey);
                    let includeDate = true;
                    
                    if (monthValue !== 'all' && date.getMonth() !== parseInt(monthValue)) {
                        includeDate = false;
                    }
                    if (yearValue !== 'all' && date.getFullYear() !== parseInt(yearValue)) {
                        includeDate = false;
                    }
                    
                    if (includeDate && date.getDay() !== 0 && !holidays.has(dateKey)) {
                        const studentAttendance = attendance[dateKey] && attendance[dateKey].students[student.id];
                        switch (studentAttendance) {
                            case 'hadir': hadir++; break;
                            case 'sakit': sakit++; break;
                            case 'izin': izin++; break;
                            case 'alpa': alpa++; break;
                        }
                    }
                });
                
                const total = hadir + sakit + izin + alpa;
                const percentage = total > 0 ? ((hadir / total) * 100).toFixed(1) + '%' : '0%';
                
                rows.push([
                    index + 1,
                    student.name,
                    student.nis,
                    hadir,
                    sakit,
                    izin,
                    alpa,
                    percentage
                ]);
            });

            return {
                title: `REKAP KEHADIRAN ${periodText}`,
                headers: headers,
                rows: rows
            };
        }

        function downloadExcel(reportData, filename, format = 'xlsx') {
            try {
                const workbook = XLSX.utils.book_new();
                let wsData = [];
                
                // Add header information
                wsData.push([reportData.title]);
                wsData.push([]);
                
                // Get school info from localStorage
                const savedData = localStorage.getItem('absenSiswaData');
                let schoolInfo = {};
                if (savedData) {
                    const data = JSON.parse(savedData);
                    schoolInfo = data.schoolInfo || {};
                }
                
                wsData.push(['Sekolah:', schoolInfo.namaSekolah || 'Nama Sekolah']);
                wsData.push(['Kelas:', schoolInfo.kelas || 'Kelas']);
                wsData.push(['Wali Kelas:', schoolInfo.waliKelas || 'Wali Kelas']);
                wsData.push(['Tanggal Cetak:', new Date().toLocaleDateString('id-ID')]);
                wsData.push([]);
                
                if (reportData.isMultiMonth && reportData.sections) {
                    // Multi-month format
                    reportData.sections.forEach((section, index) => {
                        if (index > 0) {
                            wsData.push([]);
                        }
                        wsData.push([section.title]);
                        wsData.push(section.headers);
                        
                        section.rows.forEach(row => {
                            wsData.push(row);
                        });
                    });
                } else {
                    // Single month format
                    if (reportData.headers) {
                        wsData.push(reportData.headers);
                    }
                    
                    if (reportData.rows) {
                        reportData.rows.forEach(row => {
                            wsData.push(row);
                        });
                    }
                }
                
                const worksheet = XLSX.utils.aoa_to_sheet(wsData);
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Laporan');
                
                // Create proper filename with timestamp
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const finalFilename = `${filename}_${timestamp}`;
                
                // Mobile-friendly download with proper MIME types
                const mimeTypes = {
                    'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                    'xls': 'application/vnd.ms-excel',
                    'csv': 'text/csv',
                    'ods': 'application/vnd.oasis.opendocument.spreadsheet'
                };
                
                // Generate file content
                const wbout = XLSX.write(workbook, { 
                    bookType: format, 
                    type: 'array',
                    compression: format === 'xlsx'
                });
                
                // Create blob with proper MIME type
                const blob = new Blob([wbout], { 
                    type: mimeTypes[format] || mimeTypes['xlsx']
                });
                
                // Mobile-optimized download
                if (navigator.userAgent.match(/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i)) {
                    // Mobile device - use different approach
                    const url = window.URL.createObjectURL(blob);
                    
                    // Try multiple methods for mobile compatibility
                    const downloadLink = document.createElement('a');
                    downloadLink.href = url;
                    downloadLink.download = `${finalFilename}.${format}`;
                    downloadLink.style.display = 'none';
                    
                    // Add to DOM temporarily
                    document.body.appendChild(downloadLink);
                    
                    // Trigger download with user interaction
                    downloadLink.click();
                    
                    // Clean up
                    setTimeout(() => {
                        document.body.removeChild(downloadLink);
                        window.URL.revokeObjectURL(url);
                    }, 100);
                    
                    // Show mobile-specific instructions
                    setTimeout(() => {
                        const formatNames = {
                            'xlsx': 'Excel 2007+ (.xlsx)',
                            'xls': 'Excel 97-2003 (.xls)',
                            'csv': 'CSV (.csv)',
                            'ods': 'OpenDocument (.ods)'
                        };
                        
                        alert(`üì± DOWNLOAD DIMULAI!\n\nüìÅ File: ${finalFilename}.${format}\nüìä Format: ${formatNames[format]}\n\nüí° TIPS MOBILE:\n‚Ä¢ Cek folder Download\n‚Ä¢ Jika ekstensi salah, rename file\n‚Ä¢ Gunakan app Excel/Sheets untuk buka\n\n‚úÖ File siap dibuka!`);
                    }, 500);
                    
                } else {
                    // Desktop - standard download
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${finalFilename}.${format}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    const formatNames = {
                        'xlsx': 'Excel 2007+ (.xlsx)',
                        'xls': 'Excel 97-2003 (.xls)',
                        'csv': 'CSV (.csv)',
                        'ods': 'OpenDocument (.ods)'
                    };
                    
                    alert(`‚úÖ File ${formatNames[format]} berhasil didownload!\nüìÅ Nama file: ${finalFilename}.${format}`);
                }
                
            } catch (error) {
                console.error('Excel download error:', error);
                
                // Fallback: Create simple CSV for mobile compatibility
                if (format === 'csv' || navigator.userAgent.match(/Android|iPhone|iPad|iPod/i)) {
                    try {
                        let csvContent = '';
                        
                        // Add header info
                        csvContent += `"${reportData.title}"\n\n`;
                        
                        const savedData = localStorage.getItem('absenSiswaData');
                        let schoolInfo = {};
                        if (savedData) {
                            const data = JSON.parse(savedData);
                            schoolInfo = data.schoolInfo || {};
                        }
                        
                        csvContent += `"Sekolah:","${schoolInfo.namaSekolah || 'Nama Sekolah'}"\n`;
                        csvContent += `"Kelas:","${schoolInfo.kelas || 'Kelas'}"\n`;
                        csvContent += `"Wali Kelas:","${schoolInfo.waliKelas || 'Wali Kelas'}"\n`;
                        csvContent += `"Tanggal Cetak:","${new Date().toLocaleDateString('id-ID')}"\n\n`;
                        
                        // Add data
                        if (reportData.headers) {
                            csvContent += reportData.headers.map(h => `"${h}"`).join(',') + '\n';
                        }
                        
                        if (reportData.rows) {
                            reportData.rows.forEach(row => {
                                csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
                            });
                        }
                        
                        // Create and download CSV
                        const csvBlob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                        const csvUrl = window.URL.createObjectURL(csvBlob);
                        const csvLink = document.createElement('a');
                        csvLink.href = csvUrl;
                        csvLink.download = `${filename}_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
                        document.body.appendChild(csvLink);
                        csvLink.click();
                        document.body.removeChild(csvLink);
                        window.URL.revokeObjectURL(csvUrl);
                        
                        alert('üì± File CSV berhasil didownload!\nüí° Format CSV lebih kompatibel untuk mobile');
                        
                    } catch (csvError) {
                        alert('‚ùå Error download: ' + csvError.message + '\n\nüí° Coba gunakan format CSV atau akses dari desktop');
                    }
                } else {
                    alert('‚ùå Error download: ' + error.message + '\n\nüí° Coba format CSV untuk mobile atau akses dari desktop');
                }
            }
        }

        function downloadPDF(reportData, filename) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'mm', 'a4');
                
                doc.setFontSize(16);
                doc.text(reportData.title, 20, 20);
                
                doc.setFontSize(10);
                // Get school info from localStorage
                const savedData = localStorage.getItem('absenSiswaData');
                let schoolInfo = {};
                if (savedData) {
                    const data = JSON.parse(savedData);
                    schoolInfo = data.schoolInfo || {};
                }
                
                doc.text('Sekolah: ' + (schoolInfo.namaSekolah || 'Nama Sekolah'), 20, 30);
                doc.text('Kelas: ' + (schoolInfo.kelas || 'Kelas'), 20, 35);
                doc.text('Wali Kelas: ' + (schoolInfo.waliKelas || 'Wali Kelas'), 20, 40);
                doc.text('Tanggal Cetak: ' + new Date().toLocaleDateString('id-ID'), 20, 45);
                
                if (reportData.isMultiMonth) {
                    // Multi-month format
                    let currentY = 55;
                    
                    reportData.sections.forEach((section, index) => {
                        if (index > 0) {
                            doc.addPage();
                            currentY = 20;
                        }
                        
                        doc.setFontSize(14);
                        doc.text(section.title, 20, currentY);
                        currentY += 10;
                        
                        doc.autoTable({
                            head: [section.headers],
                            body: section.rows,
                            startY: currentY,
                            styles: { fontSize: 6 },
                            headStyles: { fillColor: [20, 178, 170] },
                            margin: { top: 20 }
                        });
                        
                        currentY = doc.lastAutoTable.finalY + 20;
                    });
                } else {
                    // Single month format
                    doc.autoTable({
                        head: [reportData.headers],
                        body: reportData.rows,
                        startY: 55,
                        styles: { fontSize: 8 },
                        headStyles: { fillColor: [20, 178, 170] }
                    });
                }
                
                doc.save(`${filename}.pdf`);
                alert(`File ${filename}.pdf berhasil didownload!`);
            } catch (error) {
                alert('Error membuat file PDF: ' + error.message);
            }
        }

        // Send functions
        function sendWhatsApp() {
            const monthValue = document.getElementById('sendMonth').value;
            const yearValue = document.getElementById('sendYear').value;
            
            const message = generateReportMessage(monthValue, yearValue);
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            
            window.open(whatsappUrl, '_blank');
        }

        function sendEmail() {
            if (students.length === 0) {
                alert('Belum ada data siswa untuk dikirim!');
                return;
            }

            const monthValue = document.getElementById('sendMonth').value;
            const yearValue = document.getElementById('sendYear').value;
            
            const message = generateReportMessage(monthValue, yearValue);
            // Get school info from localStorage
            const savedData = localStorage.getItem('absenSiswaData');
            let schoolInfo = {};
            if (savedData) {
                const data = JSON.parse(savedData);
                schoolInfo = data.schoolInfo || {};
            }
            
            const schoolName = schoolInfo.namaSekolah || 'Sekolah';
            const className = schoolInfo.kelas || 'Kelas';
            const subject = `Laporan Kehadiran - ${schoolName} - ${className}`;
            
            // Method 1: Direct window.location (most reliable)
            try {
                const mailtoUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(message)}`;
                window.location.href = mailtoUrl;
                
                // Show immediate feedback
                setTimeout(() => {
                    const userChoice = confirm('üìß Apakah aplikasi email sudah terbuka?\n\n‚úÖ Klik OK jika sudah terbuka\n‚ùå Klik BATAL jika belum terbuka (akan dicoba cara lain)');
                    
                    if (!userChoice) {
                        // Method 2: Try alternative approaches
                        tryAlternativeEmailMethods(subject, message);
                    } else {
                        alert('‚úÖ Bagus! Silakan:\n1. Pilih penerima email\n2. Periksa isi laporan\n3. Klik kirim');
                    }
                }, 2000);
                
            } catch (error) {
                console.error('Primary email method failed:', error);
                tryAlternativeEmailMethods(subject, message);
            }
        }

        function tryAlternativeEmailMethods(subject, message) {
            // Method 2: Create invisible link and click
            try {
                const mailtoUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(message)}`;
                const tempLink = document.createElement('a');
                tempLink.href = mailtoUrl;
                tempLink.style.display = 'none';
                tempLink.target = '_blank';
                document.body.appendChild(tempLink);
                tempLink.click();
                document.body.removeChild(tempLink);
                
                setTimeout(() => {
                    const userChoice = confirm('üìß Apakah aplikasi email sudah terbuka sekarang?\n\n‚úÖ Klik OK jika sudah terbuka\n‚ùå Klik BATAL untuk salin manual');
                    
                    if (!userChoice) {
                        showManualCopyOption(subject, message);
                    } else {
                        alert('‚úÖ Bagus! Silakan:\n1. Pilih penerima email\n2. Periksa isi laporan\n3. Klik kirim');
                    }
                }, 2000);
                
            } catch (error) {
                console.error('Alternative email method failed:', error);
                showManualCopyOption(subject, message);
            }
        }

        function showManualCopyOption(subject, message) {
            const fullMessage = `Subject: ${subject}\n\n${message}`;
            
            // Try to copy to clipboard
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(fullMessage).then(() => {
                    alert('üìã LAPORAN DISALIN KE CLIPBOARD!\n\n‚úÖ Langkah selanjutnya:\n1. Buka aplikasi email (Gmail, Outlook, dll)\n2. Buat email baru\n3. Paste (Ctrl+V atau tahan lalu paste)\n4. Pilih penerima dan kirim\n\nüí° Laporan sudah tersalin otomatis!');
                }).catch(() => {
                    showTextAreaCopy(fullMessage);
                });
            } else {
                showTextAreaCopy(fullMessage);
            }
        }

        function showTextAreaCopy(fullMessage) {
            // Create popup with selectable text
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;
            
            popup.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 10px; max-width: 90%; max-height: 90%; overflow: auto;">
                    <h3 style="color: #0f766e; margin-bottom: 15px;">üìß SALIN LAPORAN EMAIL</h3>
                    <p style="margin-bottom: 15px; color: #374151;">Salin teks di bawah ini ke aplikasi email Anda:</p>
                    <textarea id="emailContent" style="width: 100%; height: 300px; padding: 10px; border: 2px solid #14b8a6; border-radius: 5px; font-family: monospace; font-size: 12px;" readonly>${fullMessage}</textarea>
                    <div style="margin-top: 15px; text-align: center;">
                        <button onclick="document.getElementById('emailContent').select(); document.execCommand('copy'); alert('‚úÖ Disalin! Paste ke aplikasi email Anda.');" style="background: #14b8a6; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-right: 10px; cursor: pointer;">üìã SALIN</button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove();" style="background: #6b7280; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">‚ùå TUTUP</button>
                    </div>
                    <p style="margin-top: 15px; font-size: 12px; color: #6b7280;">üí° Tips: Pilih semua teks (Ctrl+A), salin (Ctrl+C), lalu paste ke email</p>
                </div>
            `;
            
            document.body.appendChild(popup);
            
            // Auto-select text
            setTimeout(() => {
                document.getElementById('emailContent').select();
            }, 100);
        }



        function generateReportMessage(monthValue, yearValue) {
            const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                              'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            
            let periodText = '';
            if (monthValue !== 'all' && yearValue !== 'all') {
                periodText = `${monthNames[parseInt(monthValue)]} ${yearValue}`;
            } else if (monthValue !== 'all' && yearValue === 'all') {
                periodText = `${monthNames[parseInt(monthValue)]} Semua Tahun`;
            } else if (monthValue === 'all' && yearValue !== 'all') {
                periodText = `Semua Bulan ${yearValue}`;
            } else {
                periodText = 'Semua Data';
            }
            
            let message = `üìä LAPORAN KEHADIRAN SISWA\n\n`;
            // Get school info from localStorage
            const savedData = localStorage.getItem('absenSiswaData');
            let schoolInfo = {};
            if (savedData) {
                const data = JSON.parse(savedData);
                schoolInfo = data.schoolInfo || {};
            }
            
            message += `üè´ Sekolah: ${schoolInfo.namaSekolah || 'Nama Sekolah'}\n`;
            message += `üéì Kelas: ${schoolInfo.kelas || 'Kelas'}\n`;
            message += `üë®‚Äçüè´ Wali Kelas: ${schoolInfo.waliKelas || 'Wali Kelas'}\n`;
            message += `üìÖ Periode: ${periodText}\n`;
            message += `üìÜ Tanggal Cetak: ${new Date().toLocaleDateString('id-ID')}\n\n`;
            
            message += `üìà REKAP KEHADIRAN:\n`;
            message += `${'='.repeat(40)}\n`;
            
            students.forEach((student, index) => {
                let hadir = 0, sakit = 0, izin = 0, alpa = 0;
                
                Object.keys(attendance).forEach(dateKey => {
                    const date = new Date(dateKey);
                    let includeDate = true;
                    
                    if (monthValue !== 'all' && date.getMonth() !== parseInt(monthValue)) {
                        includeDate = false;
                    }
                    if (yearValue !== 'all' && date.getFullYear() !== parseInt(yearValue)) {
                        includeDate = false;
                    }
                    
                    if (includeDate && date.getDay() !== 0 && !holidays.has(dateKey)) {
                        const studentAttendance = attendance[dateKey] && attendance[dateKey].students[student.id];
                        switch (studentAttendance) {
                            case 'hadir': hadir++; break;
                            case 'sakit': sakit++; break;
                            case 'izin': izin++; break;
                            case 'alpa': alpa++; break;
                        }
                    }
                });
                
                const total = hadir + sakit + izin + alpa;
                const percentage = total > 0 ? ((hadir / total) * 100).toFixed(1) : 0;
                
                message += `${index + 1}. ${student.name}\n`;
                message += `   ‚úÖ Hadir: ${hadir} | ü§í Sakit: ${sakit} | üìù Izin: ${izin} | ‚ùå Alpa: ${alpa}\n`;
                message += `   üìä Kehadiran: ${percentage}%\n\n`;
            });
            
            message += `${'='.repeat(40)}\n`;
            message += `üì± Dibuat dengan Aplikasi Absen Siswa Digital`;
            
            return message;
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97ef0d3d67605cdf',t:'MTc1Nzg0NDE3OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
